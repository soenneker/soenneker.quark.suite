@namespace Soenneker.Quark
@inherits Soenneker.Quark.Component
@implements IIFrame

<iframe @attributes="BuildAttributes()"></iframe>

@code {
    /// <summary>
    /// Gets or sets the iframe source URL.
    /// </summary>
    [Parameter]
    public string? Source { get; set; }

    /// <summary>
    /// Gets or sets the name attribute of the iframe.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// Gets or sets the sandbox attribute value.
    /// </summary>
    [Parameter]
    public string? Sandbox { get; set; }

    /// <summary>
    /// Gets or sets the allow attribute value.
    /// </summary>
    [Parameter]
    public string? Allow { get; set; }

    /// <summary>
    /// Gets or sets the loading attribute value.
    /// </summary>
    [Parameter]
    public string? Loading { get; set; }

    /// <summary>
    /// Gets or sets whether the iframe should load lazily.
    /// </summary>
    [Parameter]
    public bool Lazy { get; set; }

    /// <summary>
    /// Gets or sets the referrerpolicy attribute value.
    /// </summary>
    [Parameter]
    public string? ReferrerPolicy { get; set; }

    /// <summary>
    /// Gets or sets whether to allow fullscreen.
    /// </summary>
    [Parameter]
    public bool AllowFullscreen { get; set; }

    /// <summary>
    /// Gets or sets whether to allow payment requests.
    /// </summary>
    [Parameter]
    public bool AllowPaymentRequest { get; set; }

    /// <summary>
    /// Gets or sets the srcdoc attribute value.
    /// </summary>
    [Parameter]
    public string? SrcDoc { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the iframe loads.
    /// </summary>
    [Parameter]
    public EventCallback<ProgressEventArgs> OnLoad { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when an iframe error occurs.
    /// </summary>
    [Parameter]
    public EventCallback<ErrorEventArgs> OnError { get; set; }

    private string? GetLoadingAttribute()
    {
        if (Lazy)
            return "lazy";
        
        return Loading;
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAttribute(attributes, (ref cls) => AppendClass(ref cls, "q-iframe"));

        // Add iframe-specific attributes
        if (Source.HasContent())
            attributes["src"] = Source;

        if (Name.HasContent())
            attributes["name"] = Name;

        if (Sandbox.HasContent())
            attributes["sandbox"] = Sandbox;

        if (Allow.HasContent())
            attributes["allow"] = Allow;

        var loadingAttr = GetLoadingAttribute();
        if (loadingAttr.HasContent())
            attributes["loading"] = loadingAttr;

        if (ReferrerPolicy.HasContent())
            attributes["referrerpolicy"] = ReferrerPolicy;

        if (AllowFullscreen)
            attributes["allowfullscreen"] = true;

        if (AllowPaymentRequest)
            attributes["allowpaymentrequest"] = true;

        if (SrcDoc.HasContent())
            attributes["srcdoc"] = SrcDoc;

        // Add event handlers
        if (OnLoad.HasDelegate)
            attributes["onload"] = EventCallback.Factory.Create(this, OnLoad);

        if (OnError.HasDelegate)
            attributes["onerror"] = EventCallback.Factory.Create(this, OnError);
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Source);
        hc.Add(Name);
        hc.Add(Sandbox);
        hc.Add(Allow);
        hc.Add(Loading);
        hc.Add(Lazy);
        hc.Add(ReferrerPolicy);
        hc.Add(AllowFullscreen);
        hc.Add(AllowPaymentRequest);
        hc.Add(SrcDoc);
    }
}