@namespace Soenneker.Quark
@inherits VisualMediaElement
@implements IImage

<img @attributes="BuildAttributes()" />

@code {
    /// <summary>
    /// Gets or sets whether the image should be fluid (responsive).
    /// </summary>
    [Parameter]
    public bool Fluid { get; set; }

    /// <summary>
    /// Gets or sets the loading attribute value.
    /// </summary>
    [Parameter]
    public string? Loading { get; set; }

    /// <summary>
    /// Gets or sets the decoding attribute value.
    /// </summary>
    [Parameter]
    public string? Decoding { get; set; }

    /// <summary>
    /// Gets or sets the fetchpriority attribute value.
    /// </summary>
    [Parameter]
    public string? FetchPriority { get; set; }

    /// <summary>
    /// Gets or sets the sizes attribute value.
    /// </summary>
    [Parameter]
    public string? Sizes { get; set; }

    /// <summary>
    /// Gets or sets the srcset attribute value.
    /// </summary>
    [Parameter]
    public string? SrcSet { get; set; }

    /// <summary>
    /// Gets or sets the crossorigin attribute value.
    /// </summary>
    [Parameter]
    public string? CrossOrigin { get; set; }

    /// <summary>
    /// Gets or sets the referrerpolicy attribute value.
    /// </summary>
    [Parameter]
    public string? ReferrerPolicy { get; set; }

    /// <summary>
    /// Gets or sets the usemap attribute value.
    /// </summary>
    [Parameter]
    public string? UseMap { get; set; }

    /// <summary>
    /// Gets or sets whether the image is a server-side image map.
    /// </summary>
    [Parameter]
    public bool IsMap { get; set; }

    /// <summary>
    /// Gets or sets the longdesc attribute value.
    /// </summary>
    [Parameter]
    public string? LongDesc { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the image loads.
    /// </summary>
    [Parameter]
    public EventCallback<ProgressEventArgs> OnLoad { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the image fails to load.
    /// </summary>
    [Parameter]
    public EventCallback<ErrorEventArgs> OnError { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the image starts loading.
    /// </summary>
    [Parameter]
    public EventCallback<ProgressEventArgs> OnLoadStart { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the image load is aborted.
    /// </summary>
    [Parameter]
    public EventCallback<ProgressEventArgs> OnAbort { get; set; }

    private string? GetLoadingAttribute()
    {
        if (Lazy)
            return "lazy";
        
        return Loading;
    }

    private string? GetFluidClass()
    {
        if (Fluid)
            return "img-fluid";
        
        return null;
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        if (!Class.HasContent())
        {
            BuildClassAttribute(attributes, (ref cls) =>
            {
                AppendClass(ref cls, "q-image");
                AppendClass(ref cls, "img-thumbnail");
                
                var fluidClass = GetFluidClass();
                if (fluidClass != null)
                    AppendClass(ref cls, fluidClass);
            });
        }
        else
        {
            var currentClass = attributes.GetValueOrDefault("class")?.ToString() ?? "";
            var fluidClass = GetFluidClass();
            
            if (fluidClass != null && !currentClass.Contains(fluidClass))
            {
                BuildClassAttribute(attributes, (ref cls) => AppendClass(ref cls, fluidClass));
            }
        }

        // Add image-specific attributes
        if (Source.HasContent())
            attributes["src"] = Source;

        if (Alt.HasContent())
            attributes["alt"] = Alt;

        var loadingAttr = GetLoadingAttribute();
        if (loadingAttr.HasContent())
            attributes["loading"] = loadingAttr;

        if (Decoding.HasContent())
            attributes["decoding"] = Decoding;

        if (FetchPriority.HasContent())
            attributes["fetchpriority"] = FetchPriority;

        if (Sizes.HasContent())
            attributes["sizes"] = Sizes;

        if (SrcSet.HasContent())
            attributes["srcset"] = SrcSet;

        if (CrossOrigin.HasContent())
            attributes["crossorigin"] = CrossOrigin;

        if (ReferrerPolicy.HasContent())
            attributes["referrerpolicy"] = ReferrerPolicy;

        if (UseMap.HasContent())
            attributes["usemap"] = UseMap;

        if (IsMap)
            attributes["ismap"] = true;

        if (LongDesc.HasContent())
            attributes["longdesc"] = LongDesc;

        // Add event handlers
        if (OnLoad.HasDelegate)
            attributes["onload"] = EventCallback.Factory.Create(this, OnLoad);

        if (OnError.HasDelegate)
            attributes["onerror"] = EventCallback.Factory.Create(this, OnError);

        if (OnLoadStart.HasDelegate)
            attributes["onloadstart"] = EventCallback.Factory.Create(this, OnLoadStart);

        if (OnAbort.HasDelegate)
            attributes["onabort"] = EventCallback.Factory.Create(this, OnAbort);
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Fluid);
        hc.Add(Loading);
        hc.Add(Decoding);
        hc.Add(FetchPriority);
        hc.Add(Sizes);
        hc.Add(SrcSet);
        hc.Add(CrossOrigin);
        hc.Add(ReferrerPolicy);
        hc.Add(UseMap);
        hc.Add(IsMap);
        hc.Add(LongDesc);
    }
}