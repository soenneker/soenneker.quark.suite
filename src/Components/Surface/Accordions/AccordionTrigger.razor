@namespace Soenneker.Quark
@inherits Soenneker.Quark.SurfaceElement
@implements IAccordionTrigger

<h3 class="flex">
    <button @onclick="HandleTriggerClick" @attributes="BuildAttributes()">
        @ChildContent
        @if (ShowChevron)
        {
            <Icon Name="chevron-down" Class="text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200" />
        }
    </button>
</h3>

@code {
    [Parameter]
    public bool ShowChevron { get; set; } = true;

    [CascadingParameter(Name = nameof(ParentAccordionItem))]
    public AccordionItem? ParentAccordionItem { get; set; }

    private async Task HandleTriggerClick(MouseEventArgs args)
    {
        if (ParentAccordionItem is null || ParentAccordionItem.Disabled)
            return;

        await ParentAccordionItem.Toggle();
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        var isOpen = ParentAccordionItem?.IsOpen == true;
        var disabled = ParentAccordionItem?.Disabled == true;

        attributes["type"] = "button";
        attributes["data-slot"] = "accordion-trigger";
        attributes["data-state"] = isOpen ? "open" : "closed";
        attributes["aria-expanded"] = isOpen ? "true" : "false";

        if (ParentAccordionItem is not null)
            attributes["aria-controls"] = ParentAccordionItem.ContentId;

        if (disabled)
            attributes["disabled"] = true;

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-accordion-trigger");
            AppendClass(ref cls, "focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180");
        });

        if (ParentAccordionItem is not null)
            attributes["id"] = ParentAccordionItem.TriggerId;
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(ShowChevron);
        hc.Add(ParentAccordionItem?.IsOpen == true);
    }
}
