@using System.Runtime.CompilerServices
@using Soenneker.Quark.Components.Surface.Interactive.Buttons.Abstract

@namespace Soenneker.Quark
@inherits InteractiveSurfaceElement
@implements IButton
@inject NavigationManager Navigation

@if (Type == ButtonType.Link)
{
    <Anchor To="To" Attributes="BuildAttributes()">
        @ChildContent
    </Anchor>
}
else
{
    <button @onclick="HandleClick" @attributes="BuildAttributes()">
        @if (Loading)
        {
            <span class="animate-spin size-4 mr-2 inline-block rounded-full border-2 border-current border-t-transparent" role="status" aria-hidden="true"></span>
        }
        @if (LoadingTemplate is not null && Loading)
        {
            @LoadingTemplate
        }
        else
        {
            @ChildContent
        }
    </button>
}

@code {
    /// <summary>
    /// Gets or sets the size of the button.
    /// </summary>
    [Parameter]
    public CssValue<SizeBuilder>? Size { get; set; }

    /// <summary>
    /// Gets or sets whether the button is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether the button should use outline styling.
    /// </summary>
    [Parameter]
    public bool Outline { get; set; }

    /// <summary>
    /// Gets or sets whether the button should span the full width of its container.
    /// </summary>
    [Parameter]
    public bool Block { get; set; }

    /// <summary>
    /// Gets or sets whether the button is in a loading state.
    /// </summary>
    [Parameter]
    public bool Loading { get; set; }

    /// <summary>
    /// Gets or sets the type of the button (button, submit, reset, or link).
    /// </summary>
    [Parameter]
    public ButtonType Type { get; set; } = ButtonType.Button;

    /// <summary>
    /// Gets or sets the template to display when the button is in a loading state.
    /// </summary>
    [Parameter]
    public RenderFragment? LoadingTemplate { get; set; }

    /// <summary>
    /// Gets or sets the value attribute of the button.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Gets or sets the form ID that this button is associated with.
    /// </summary>
    [Parameter]
    public string? Form { get; set; }

    /// <summary>
    /// Gets or sets whether the button should automatically receive focus when the page loads.
    /// </summary>
    [Parameter]
    public bool AutoFocus { get; set; }

    /// <summary>
    /// Gets or sets the navigation target URL when the button type is Link.
    /// </summary>
    [Parameter]
    public string? To { get; set; }

    /// <summary>
    /// Gets or sets the name attribute of the button.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// Gets or sets the ID of the collapse element to toggle when clicked.
    /// </summary>
    [Parameter]
    public string? CollapseTarget { get; set; }

    /// <summary>
    /// Gets or sets the reference to the collapse component to toggle when clicked.
    /// </summary>
    [Parameter]
    public Collapse? CollapseTargetRef { get; set; }

    /// <summary>
    /// Gets or sets whether the button should render as a close button.
    /// </summary>
    [Parameter]
    public bool Close { get; set; }

    /// <summary>
    /// Gets or sets whether the button should render without Bootstrap button styling.
    /// </summary>
    [Parameter]
    public bool Unstyled { get; set; }

    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    private string? GetSizeClass()
    {
        if (Size == Quark.Size.Default)
            return null;

        string? token = null;
        bool isTheme = Size?.TryGetBootstrapThemeToken(out token) == true;
        var sizeValue = token ?? Size?.ToString();
        if (string.IsNullOrEmpty(sizeValue)) return null;
        return sizeValue.ToLowerInvariant() switch
        {
            "sm" => "h-9 rounded-md px-3 text-xs",
            "lg" => "h-11 rounded-md px-8",
            _ => "h-10 px-4 py-2"
        };
    }

    /// <summary>
    /// Builds the attributes dictionary for the button component.
    /// </summary>
    /// <returns>A dictionary of HTML attributes.</returns>
    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        // Determine element kind
        bool isLink = Type == ButtonType.Link || To.HasContent();

        // Figure out disabled state (treat presence of "disabled" attribute as true)
        bool isDisabled = Disabled || Loading || attributes.ContainsKey("disabled");

        // Links that are disabled/loading should not be in tab order (unless user explicitly set TabIndex)
        if (isLink && isDisabled && !attributes.ContainsKey("tabindex"))
            attributes["tabindex"] = -1;

        // Add Tailwind (Blueprint/shadcn) button classes unless explicitly unstyled
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-button");
            if (Close)
            {
                AppendClass(ref cls, "rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none");
            }
            else if (!Unstyled)
            {
                AppendClass(ref cls, "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed");
            }

            if (!Unstyled)
            {
                string? sizeClass = GetSizeClass();
                if (sizeClass is not null)
                    AppendClass(ref cls, sizeClass);

                if (Block)
                    AppendClass(ref cls, "w-full");
            }

            if (isLink && isDisabled)
                AppendClass(ref cls, "pointer-events-none opacity-50");
        });

        // Common ARIA for loading/disabled
        if (Loading)
            attributes["aria-busy"] = "true";

        // Only set type on real <button>
        if (!isLink)
            attributes["type"] = Type.Value;

        // Real disabled vs. aria-disabled
        if (isLink)
        {
            // Anchor can't be truly disabled; use ARIA
            if (isDisabled)
            {
                attributes["aria-disabled"] = "true";
                // role is already a good idea for link-as-button
                attributes["role"] = "button";
            }
            else
                attributes.TryAdd("role", "button");
        }
        else
        {
            if (isDisabled)
                attributes["disabled"] = true;
        }

        // Standard button/submit metadata
        if (Value.HasContent()) attributes["value"] = Value!;
        if (Name.HasContent()) attributes["name"] = Name!;
        if (Form.HasContent()) attributes["form"] = Form!;
        if (AutoFocus) attributes["autofocus"] = true;

        // Collapse toggle wiring if requested (aria-controls for accessibility)
        string? targetId = CollapseTargetRef?.Id ?? CollapseTarget;
        if (targetId.HasContent())
        {
            string id = targetId!.StartsWith("#") ? targetId.Substring(1) : targetId;
            attributes["aria-controls"] = id;
        }

        // If this is acting as a link, we already render <Anchor>; nothing special beyond attrs.
    }

    /// <summary>
    /// Handles the click event for the button.
    /// </summary>
    /// <param name="args">The mouse event arguments.</param>
    protected override async Task HandleClick(MouseEventArgs args)
    {
        // Respect disabled state at runtime, same semantics as in BuildAttributes
        bool isDisabled = Disabled || Loading || (Attributes is not null && Attributes.ContainsKey("disabled"));
        if (isDisabled)
            return;

        // Programmatic navigation if To is set (and not a hash)
        if (To.HasContent() && !To!.StartsWith("#"))
            Navigation.NavigateTo(To!);

        await base.HandleClick(args);
    }

    /// <summary>
    /// Applies background color styling to the button.
    /// </summary>
    /// <param name="sty">The style string builder.</param>
    /// <param name="cls">The class string builder.</param>
    protected override void ApplyBackgroundColor(ref PooledStringBuilder sty, ref PooledStringBuilder cls)
    {
        if (BackgroundColor is not null && !BackgroundColor.Value.IsEmpty && !Close)
        {
            string v = BackgroundColor.Value.ToString().Trim();
            bool isColorTheme = BackgroundColor.Value.TryGetBootstrapThemeToken(out string? colorToken);
            string? token = isColorTheme ? colorToken : (BackgroundColor.Value.IsCssClass ? v : null);

            if (token is not null)
            {
                // Map theme tokens to shadcn/Tailwind button variants
                string variant = (Outline ? "_outline_" : "_") + token.ToLowerInvariant();
                string? tailwind = variant switch
                {
                    "_primary" => "bg-primary text-primary-foreground hover:bg-primary/90",
                    "_secondary" => "bg-secondary text-secondary-foreground hover:bg-secondary/80",
                    "_destructive" or "_danger" => "bg-destructive text-destructive-foreground hover:bg-destructive/90",
                    "_outline_primary" or "_outline_secondary" or "_outline_danger" or "_outline_destructive" or "_outline_success" or "_outline_warning" or "_outline_info" => "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
                    "_outline_" => "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
                    "_success" => "bg-primary text-primary-foreground hover:bg-primary/90",
                    "_warning" or "_info" or "_light" or "_dark" => "bg-secondary text-secondary-foreground hover:bg-secondary/80",
                    _ when Outline => "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
                    _ => "bg-primary text-primary-foreground hover:bg-primary/90"
                };
                if (tailwind is not null)
                    AppendClass(ref cls, tailwind);
            }
            else
            {
                AppendStyleDecl(ref sty, $"border-color:{v}");
            }
        }
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        AddIf(ref hc, Size);
        hc.Add(Disabled);
        hc.Add(Outline);
        hc.Add(Block);
        hc.Add(Loading);
        hc.Add(Type);
        hc.Add(LoadingTemplate);
        hc.Add(Value);
        hc.Add(Form);
        hc.Add(AutoFocus);
        hc.Add(To);
        hc.Add(Name);
        hc.Add(CollapseTarget);
        if (CollapseTargetRef?.Id is not null)
            hc.Add(CollapseTargetRef.Id);
        hc.Add(Close);
        hc.Add(Unstyled);
    }
}