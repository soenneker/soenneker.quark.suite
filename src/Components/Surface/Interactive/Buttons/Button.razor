@using System.Runtime.CompilerServices
@using Soenneker.Quark.Components.Surface.Interactive.Buttons.Abstract

@namespace Soenneker.Quark
@inherits InteractiveSurfaceElement
@implements IButton
@inject NavigationManager Navigation

@if (Type == ButtonType.Link)
{
    <Anchor To="To" Attributes="BuildAttributes()">
        @ChildContent
    </Anchor>
}
else
{
    <button @onclick="HandleClick" @attributes="BuildAttributes()">
        @if (Loading)
        {
            <span class="animate-spin size-4 mr-2 inline-block rounded-full border-2 border-current border-t-transparent" role="status" aria-hidden="true"></span>
        }
        @if (LoadingTemplate is not null && Loading)
        {
            @LoadingTemplate
        }
        else
        {
            @ChildContent
        }
    </button>
}

@code {
    // shadcn button base
    private const string _buttonBase =
        "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors " +
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 " +
        "cursor-pointer disabled:pointer-events-none disabled:opacity-50 disabled:cursor-not-allowed " +
        "[&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0";

    /// <summary>
    /// Gets or sets the size of the button (shadcn: default, xs, sm, lg, icon, icon-xs, icon-sm, icon-lg).
    /// </summary>
    [Parameter]
    public ButtonSize Size { get; set; } = ButtonSize.Default;

    /// <summary>
    /// Gets or sets whether the button is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether the button should span the full width of its container.
    /// </summary>
    [Parameter]
    public bool Block { get; set; }

    /// <summary>
    /// Gets or sets whether the button is in a loading state (opinionated extension with shadcn styling).
    /// </summary>
    [Parameter]
    public bool Loading { get; set; }

    /// <summary>
    /// Gets or sets the type of the button (button, submit, reset, or link).
    /// </summary>
    [Parameter]
    public ButtonType Type { get; set; } = ButtonType.Button;

    /// <summary>
    /// Gets or sets the template to display When the button is in a loading state.
    /// </summary>
    [Parameter]
    public RenderFragment? LoadingTemplate { get; set; }

    /// <summary>
    /// Gets or sets the value attribute of the button.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Gets or sets the form ID that this button is associated with.
    /// </summary>
    [Parameter]
    public string? Form { get; set; }

    /// <summary>
    /// Gets or sets whether the button should automatically receive focus When the page loads.
    /// </summary>
    [Parameter]
    public bool AutoFocus { get; set; }

    /// <summary>
    /// Gets or sets the navigation target URL When the button type is Link.
    /// </summary>
    [Parameter]
    public string? To { get; set; }

    /// <summary>
    /// Gets or sets the name attribute of the button.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// Gets or sets the visual style variant (shadcn/ui).
    /// </summary>
    [Parameter]
    public ButtonVariant Variant { get; set; } = ButtonVariant.Default;

    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    private static string GetShadcnVariantClass(ButtonVariant variant)
        => variant switch
        {
            ButtonVariant.Default => "bg-primary text-primary-foreground hover:bg-primary/90",
            ButtonVariant.Destructive => "bg-destructive text-destructive-foreground hover:bg-destructive/90",
            ButtonVariant.Outline => "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
            ButtonVariant.Secondary => "bg-secondary text-secondary-foreground hover:bg-secondary/80",
            ButtonVariant.Ghost => "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
            ButtonVariant.Link => "text-primary underline-offset-4 hover:underline",
            _ => "bg-primary text-primary-foreground hover:bg-primary/90",
        };

    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    private static string GetShadcnSizeClass(ButtonSize size)
        => size switch
        {
            ButtonSize.Default => "h-9 px-4 py-2 has-[>svg]:px-3",
            ButtonSize.Xs => "h-6 gap-1 rounded-md px-2 text-xs has-[>svg]:px-1.5 [&_svg:not([class*='size-'])]:size-3",
            ButtonSize.Sm => "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
            ButtonSize.Lg => "h-10 rounded-md px-6 has-[>svg]:px-4",
            ButtonSize.Icon => "size-9",
            ButtonSize.IconXs => "size-6 rounded-md [&_svg:not([class*='size-'])]:size-3",
            ButtonSize.IconSm => "size-8",
            ButtonSize.IconLg => "size-10",
            _ => "h-9 px-4 py-2 has-[>svg]:px-3",
        };

    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    private static string GetSizeDataAttr(ButtonSize size)
        => size switch
        {
            ButtonSize.Default => "default",
            ButtonSize.Xs => "xs",
            ButtonSize.Sm => "sm",
            ButtonSize.Lg => "lg",
            ButtonSize.Icon => "icon",
            ButtonSize.IconXs => "icon-xs",
            ButtonSize.IconSm => "icon-sm",
            ButtonSize.IconLg => "icon-lg",
            _ => "default"
        };

    /// <summary>
    /// Builds the attributes dictionary for the button component.
    /// </summary>
    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        var isLink = Type == ButtonType.Link || To.HasContent();
        var isDisabled = Disabled || Loading || attributes.ContainsKey("disabled");

        // shadcn-style data attrs (safe for both <button> and <a>)
        attributes["data-variant"] = Variant.ToString().ToLowerInvariant();
        attributes["data-size"] = GetSizeDataAttr(Size);

        if (isLink && isDisabled && !attributes.ContainsKey("tabindex"))
            attributes["tabindex"] = -1;

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-button");
            AppendClass(ref cls, _buttonBase);
            AppendClass(ref cls, GetShadcnSizeClass(Size));
            if (Block)
                AppendClass(ref cls, "w-full");
            AppendClass(ref cls, GetShadcnVariantClass(Variant));

            if (isLink && isDisabled)
                AppendClass(ref cls, "pointer-events-none opacity-50");
        });

        if (Loading)
            attributes["aria-busy"] = "true";

        if (!isLink)
            attributes["type"] = Type.Value;

        if (isLink)
        {
            if (isDisabled)
            {
                attributes["aria-disabled"] = "true";
                attributes["role"] = "button";
            }
            else
            {
                attributes.TryAdd("role", "button");
            }
        }
        else
        {
            if (isDisabled)
                attributes["disabled"] = true;
        }

        if (Value.HasContent()) attributes["value"] = Value!;
        if (Name.HasContent()) attributes["name"] = Name!;
        if (Form.HasContent()) attributes["form"] = Form!;
        if (AutoFocus) attributes["autofocus"] = true;
    }

    protected override async Task HandleClick(MouseEventArgs args)
    {
        var isDisabled = Disabled || Loading || (Attributes is not null && Attributes.ContainsKey("disabled"));
        if (isDisabled)
            return;

        if (To.HasContent() && !To!.StartsWith("#"))
            Navigation.NavigateTo(To!);

        await base.HandleClick(args);
    }

    protected override void ApplyBorderColor(ref PooledStringBuilder sty, ref PooledStringBuilder cls)
    {
        // shadcn Button: border rules are handled by variant classes only.
    }

    protected override void ApplyBackgroundColor(ref PooledStringBuilder sty, ref PooledStringBuilder cls)
    {
        // shadcn Button: background rules are handled by variant classes only.
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Size);
        hc.Add(Disabled);
        hc.Add(Block);
        hc.Add(Loading);
        hc.Add(Type);
        hc.Add(LoadingTemplate);
        hc.Add(Value);
        hc.Add(Form);
        hc.Add(AutoFocus);
        hc.Add(To);
        hc.Add(Name);
        hc.Add(Variant);
    }
}
