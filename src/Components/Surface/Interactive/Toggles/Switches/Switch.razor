@using Soenneker.Blazor.Extensions.EventCallback

@namespace Soenneker.Quark
@inherits ToggleElement
@implements Soenneker.Quark.IValidationInput
@implements ISwitch
<div @attributes="BuildWrapperAttributes()">
    <label class="inline-flex cursor-pointer items-center gap-2">
        <span class="group/switch relative inline-flex shrink-0">
            <input id="@Id" type="checkbox" checked="@Checked" @onclick="HandleClick" @onchange="HandleChange" @attributes="BuildInputAttributes()" />
            <span @attributes="BuildTrackAttributes()">
                <span class="@GetThumbClass()"></span>
            </span>
        </span>
        @if (ChildContent != null)
        {
            <span @attributes="BuildLabelAttributes()">@ChildContent</span>
        }
        else if (Label.HasContent())
        {
            <span @attributes="BuildLabelAttributes()">@Label</span>
        }
    </label>
</div>

@code {
    public override string? Id { get; set; } = $"switch-{Guid.NewGuid():N}";

    [Parameter]
    public string? Label { get; set; }

    [Parameter]
    public CssValue<SizeBuilder>? Size { get; set; } = Quark.Size.Default;

    [Parameter]
    public EventCallback<ChangeEventArgs> OnChange { get; set; }

    [CascadingParameter(Name = nameof(ParentValidation))]
    public Validation? ParentValidation { get; set; }

    public object? ValidationValue => Checked;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ParentValidation is not null)
        {
            if (CheckedExpression is not null)
                await ParentValidation.InitializeInputExpression(CheckedExpression);

            await ParentValidation.InitializeInput(this);
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private bool IsSmSize()
    {
        if (Size == null) return false;
        var s = Size.Value.ToString()?.ToLowerInvariant();
        return s == "sm" || s == "xs";
    }

    protected Dictionary<string, object> BuildWrapperAttributes()
    {
        var attributes = new Dictionary<string, object>();
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-switch");
            AppendClass(ref cls, "flex items-center gap-2");
        });

        if (Id.HasContent())
            attributes["id"] = Id;

        if (Style.HasContent())
            attributes["style"] = Style;

        return attributes;
    }

    private Dictionary<string, object> BuildLabelAttributes()
    {
        var attributes = new Dictionary<string, object>();
        BuildClassAttribute(attributes, (ref cls) => AppendClass(ref cls, "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-50"));
        return attributes;
    }

    // Switch track: peer inline-flex shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent, transition-colors, focus-visible:ring-2, disabled:*, size, checked:bg-primary / bg-input
    private Dictionary<string, object> BuildTrackAttributes()
    {
        var attributes = new Dictionary<string, object>();
        bool sm = IsSmSize();
        attributes["data-size"] = sm ? "sm" : "default";
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "group/switch peer inline-flex shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors outline-none peer-focus-visible:ring-2 peer-focus-visible:ring-ring peer-focus-visible:ring-offset-2 peer-focus-visible:ring-offset-background peer-disabled:cursor-not-allowed peer-disabled:opacity-50");
            AppendClass(ref cls, Checked ? "bg-primary" : "bg-input");
            AppendClass(ref cls, sm ? "h-5 w-9" : "h-6 w-11");
            string? v = GetValidationClass();
            if (v != null) AppendClass(ref cls, v);
        });
        return attributes;
    }

    private Dictionary<string, object> BuildInputAttributes()
    {
        var attributes = new Dictionary<string, object>();
        attributes["class"] = "sr-only peer";
        if (Disabled)
            attributes["disabled"] = true;
        if (ParentValidation?.Status == ValidationStatus.Error)
            attributes["aria-invalid"] = "true";
        return attributes;
    }

    private string? GetValidationClass()
    {
        if (ParentValidation?.Status == ValidationStatus.Error)
            return "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive";
        return null;
    }

    // Switch thumb: pointer-events-none block rounded-full bg-background shadow-lg ring-0 transition-transform + size + translate
    private string GetThumbClass()
    {
        bool sm = IsSmSize();
        string size = sm ? "h-4 w-4" : "h-5 w-5";
        string translate = Checked ? (sm ? "translate-x-4" : "translate-x-5") : "translate-x-0";
        return $"pointer-events-none block rounded-full bg-background shadow-lg ring-0 transition-transform {size} {translate}";
    }

    protected override async Task HandleClick(MouseEventArgs args)
    {
        if (Disabled)
            return;

        bool next = !Checked;
        if (next == Checked)
            return;

        Checked = next;
        await CheckedChanged.InvokeAsync(next);

        InvalidateRender();
        Refresh();

        if (ParentValidation is not null)
        {
            ParentValidation.MarkTouched();
            await ParentValidation.NotifyInputChanged(next);
        }
    }

    private Task HandleChange(ChangeEventArgs e)
    {
        return OnChange.InvokeIfHasDelegate(e);
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        base.ComputeRenderKeyCore(ref hc);

        hc.Add(Checked);
        hc.Add(Disabled);
        hc.Add(Name);
        hc.Add(Value);
        hc.Add(Label);
        AddIf(ref hc, Size);
    }
}
