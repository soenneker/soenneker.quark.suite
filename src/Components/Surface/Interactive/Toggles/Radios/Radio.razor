@using Soenneker.Blazor.Extensions.EventCallback

@namespace Soenneker.Quark
@inherits ToggleElement
@implements Soenneker.Quark.IValidationInput
@implements IRadio
@if (ChildContent != null)
{
    <div @attributes="BuildWrapperAttributes()">
        <input id="@Id" type="radio" checked="@Checked" @onchange="HandleChange" @attributes="BuildAttributes()" />
        <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-50" for="@Id">
            @ChildContent
        </label>
    </div>
}
else
{
    <input id="@Id" type="radio" checked="@Checked" @onchange="HandleChange" @attributes="BuildAttributes()" />
}

@code {
    /// <summary>
    /// Gets or sets the callback invoked when the radio state changes.
    /// </summary>
    [Parameter]
    public EventCallback<ChangeEventArgs> OnChange { get; set; }

    [CascadingParameter(Name = nameof(ParentValidation))]
    public Validation? ParentValidation { get; set; }

    /// <summary>
    /// Gets or sets the size of the radio.
    /// </summary>
    [Parameter]
    public CssValue<SizeBuilder>? Size { get; set; } = Quark.Size.Default;

    /// <summary>
    /// Gets or sets whether the radio should be displayed inline.
    /// </summary>
    [Parameter]
    public bool Inline { get; set; }

    /// <summary>
    /// Gets the value used for validation.
    /// </summary>
    public object? ValidationValue => Checked;

    protected override void OnInitialized()
    {
        if (Id.IsNullOrEmpty())
            Id = $"radio_{Guid.NewGuid():N}";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ParentValidation is not null)
        {
            await ParentValidation.InitializeInput(this);

            if (CheckedExpression is not null)
                await ParentValidation.InitializeInputExpression(CheckedExpression);
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private Dictionary<string, object> BuildWrapperAttributes()
    {
        var attributes = new Dictionary<string, object>();
        
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-radio");
            AppendClass(ref cls, "flex items-center gap-2");
            if (Inline)
                AppendClass(ref cls, "inline-flex");
        });

        return attributes;
    }

    private string? GetSizeClass()
    {
        if (Size == Quark.Size.Default)
            return null;

        var sizeValue = Size?.ToString()?.ToLowerInvariant();
        return sizeValue switch
        {
            "xs" => "h-3 w-3",
            "sm" => "h-3.5 w-3.5",
            "md" => "h-4 w-4",
            "lg" => "h-5 w-5",
            "xl" => "h-7 w-7",
            "xxl" => "h-8 w-8",
            _ => sizeValue.HasContent() ? "h-4 w-4" : null
        };
    }

    private async Task HandleChange(ChangeEventArgs e)
    {
        if (!Checked)
        {
            Checked = true;
            await CheckedChanged.InvokeAsync(true);
            InvalidateRender();
        }

        await OnChange.InvokeIfHasDelegate(e);

        if (ParentValidation is not null)
        {
            ParentValidation.MarkTouched();
            await ParentValidation.NotifyInputChanged(Checked);
        }
    }

    // shadcn RadioGroupItem - new-york-v4 ui/radio-group.tsx
    private const string _shadcnRadioItemBase =
        "border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50";

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        attributes.TryAdd("data-slot", "radio-group-item");

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, _shadcnRadioItemBase);
            string? sizeClass = GetSizeClass();
            if (sizeClass != null)
                AppendClass(ref cls, sizeClass);
            string? validationClass = GetValidationClass();
            if (validationClass != null)
                AppendClass(ref cls, validationClass);
        });

        if (Disabled)
            attributes["disabled"] = true;
        if (Value.HasContent())
            attributes["value"] = Value;
        if (Name.HasContent())
            attributes["name"] = Name;
        if (ParentValidation?.Status == ValidationStatus.Error)
            attributes["aria-invalid"] = "true";
    }

    private string? GetValidationClass()
    {
        if (ParentValidation?.Status == ValidationStatus.Error)
            return "border-destructive ring-destructive/20 dark:ring-destructive/40";
        return null;
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Checked);
        hc.Add(Disabled);
        hc.Add(Name);
        hc.Add(Value);
        AddIf(ref hc, Size);
        hc.Add(Inline);
    }
}