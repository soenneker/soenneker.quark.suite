@using Soenneker.Blazor.Extensions.EventCallback

@namespace Soenneker.Quark
@inherits Soenneker.Quark.InteractiveSurfaceElement
@implements IToggle

<button @onclick="HandleClick" @attributes="BuildAttributes()">
    @ChildContent
</button>

@code {
    /// <summary>
    /// Gets or sets whether the toggle is pressed.
    /// </summary>
    [Parameter]
    public bool Pressed { get; set; }

    /// <summary>
    /// Gets or sets callback invoked when pressed state changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> PressedChanged { get; set; }

    /// <summary>
    /// Gets or sets whether the toggle is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets visual variant.
    /// </summary>
    [Parameter]
    public ToggleVariant Variant { get; set; } = ToggleVariant.Default;

    /// <summary>
    /// Gets or sets size.
    /// </summary>
    [Parameter]
    public ToggleSize Size { get; set; } = ToggleSize.Default;

    private static string GetVariantClass(ToggleVariant variant)
        => variant switch
        {
            ToggleVariant.Default => "bg-transparent",
            ToggleVariant.Outline => "border border-input bg-transparent shadow-xs hover:bg-accent hover:text-accent-foreground",
            _ => "bg-transparent"
        };

    private static string GetSizeClass(ToggleSize size)
        => size switch
        {
            ToggleSize.Default => "h-9 px-2 min-w-9",
            ToggleSize.Small => "h-8 px-1.5 min-w-8",
            ToggleSize.Large => "h-10 px-2.5 min-w-10",
            _ => "h-9 px-2 min-w-9"
        };

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        attributes["type"] = "button";
        attributes["aria-pressed"] = Pressed ? "true" : "false";
        attributes["data-state"] = Pressed ? "on" : "off";
        attributes["data-variant"] = Variant.ToString().ToLowerInvariant();

        if (Disabled)
            attributes["disabled"] = true;

        // shadcn/ui toggle base - exact copy from new-york-v4 ui/toggle.tsx
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-toggle");
            AppendClass(ref cls, "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium hover:bg-muted hover:text-muted-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] outline-none transition-[color,box-shadow] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive whitespace-nowrap");
            AppendClass(ref cls, GetVariantClass(Variant));
            AppendClass(ref cls, GetSizeClass(Size));
        });
    }

    protected override async Task HandleClick(MouseEventArgs e)
    {
        if (Disabled)
            return;

        var next = !Pressed;
        if (next == Pressed)
            return;

        Pressed = next;
        await PressedChanged.InvokeAsync(next);
        await OnClick.InvokeIfHasDelegate(e);

        InvalidateRender();
        Refresh();
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        base.ComputeRenderKeyCore(ref hc);

        hc.Add(Pressed);
        hc.Add(Disabled);
        hc.Add(Variant);
        hc.Add(Size);
    }
}
