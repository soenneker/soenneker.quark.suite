@using Soenneker.Blazor.Extensions.EventCallback

@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element

<CascadingValue Name="ParentInputOtp" Value="@this" IsFixed="true">
    <div @attributes="BuildAttributes()">
        @ChildContent
    </div>
</CascadingValue>

@code {
    /// <summary>
    /// Gets or sets the OTP value.
    /// </summary>
    [Parameter]
    public string Value { get; set; } = "";

    /// <summary>
    /// Gets or sets the number of slots.
    /// </summary>
    [Parameter]
    public int Length { get; set; } = 6;

    /// <summary>
    /// Gets or sets callback when value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets whether the input is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    internal async Task SetValue(string v)
    {
        if (v.Length > Length) v = v[..Length];
        Value = v;
        await ValueChanged.InvokeAsync(Value);
        InvalidateRender();
        Refresh();
    }

    internal char? GetSlot(int index)
    {
        if (index < 0 || index >= Length) return null;
        var v = Value ?? "";
        return index < v.Length ? v[index] : (char?)null;
    }

    internal int ActiveIndex => Math.Min((Value ?? "").Length, Length - 1);

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        attributes["data-slot"] = "input-otp";
        if (Disabled)
            attributes["data-disabled"] = "true";

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-input-otp");
            AppendClass(ref cls, "flex items-center gap-2 has-[[data-disabled]]:opacity-50");
        });
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        base.ComputeRenderKeyCore(ref hc);
        hc.Add(Value);
        hc.Add(Length);
        hc.Add(Disabled);
    }
}
