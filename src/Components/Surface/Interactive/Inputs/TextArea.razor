@using System.Linq.Expressions
@using Soenneker.Blazor.Extensions.EventCallback

@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements ITextArea

<textarea @attributes="BuildAttributes()"
          value="@Value"
          @oninput="HandleInput"
          @onchange="HandleChange"></textarea>

@code {
    /// <summary>
    /// Gets or sets the textarea value.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the textarea value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets the expression used for validation.
    /// </summary>
    [Parameter]
    public Expression<Func<string?>>? ValueExpression { get; set; }

    /// <summary>
    /// Gets or sets placeholder text.
    /// </summary>
    [Parameter]
    public string? Placeholder { get; set; }

    /// <summary>
    /// Gets or sets whether the textarea is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether the textarea is read-only.
    /// </summary>
    [Parameter]
    public bool ReadOnly { get; set; }

    /// <summary>
    /// Gets or sets whether the textarea is required.
    /// </summary>
    [Parameter]
    public bool Required { get; set; }

    /// <summary>
    /// Gets or sets minimum length.
    /// </summary>
    [Parameter]
    public int? MinLength { get; set; }

    /// <summary>
    /// Gets or sets maximum length.
    /// </summary>
    [Parameter]
    public int? MaxLength { get; set; }

    /// <summary>
    /// Gets or sets visible row count.
    /// </summary>
    [Parameter]
    public int? Rows { get; set; }

    /// <summary>
    /// Gets or sets callback invoked for input events.
    /// </summary>
    [Parameter]
    public EventCallback<ChangeEventArgs> OnInput { get; set; }

    /// <summary>
    /// Gets or sets callback invoked for change events.
    /// </summary>
    [Parameter]
    public EventCallback<ChangeEventArgs> OnChange { get; set; }

    private async Task HandleInput(ChangeEventArgs e)
    {
        var next = e.Value?.ToString();
        var valueChanged = !string.Equals(Value, next, StringComparison.Ordinal);
        Value = next;

        if (valueChanged)
            await ValueChanged.InvokeIfHasDelegate(Value);

        await OnInput.InvokeIfHasDelegate(e);

        if (valueChanged)
        {
            InvalidateRender();
            Refresh();
        }
    }

    private async Task HandleChange(ChangeEventArgs e)
    {
        var next = e.Value?.ToString();
        var valueChanged = !string.Equals(Value, next, StringComparison.Ordinal);
        Value = next;

        if (valueChanged)
            await ValueChanged.InvokeIfHasDelegate(Value);

        await OnChange.InvokeIfHasDelegate(e);

        if (valueChanged)
        {
            InvalidateRender();
            Refresh();
        }
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        if (!string.IsNullOrWhiteSpace(Placeholder))
            attributes["placeholder"] = Placeholder!;
        if (Disabled)
            attributes["disabled"] = true;
        if (ReadOnly)
            attributes["readonly"] = true;
        if (Required)
            attributes["required"] = true;
        if (MinLength.HasValue)
            attributes["minlength"] = MinLength.Value;
        if (MaxLength.HasValue)
            attributes["maxlength"] = MaxLength.Value;
        if (Rows.HasValue)
            attributes["rows"] = Rows.Value;

        // shadcn/ui textarea base - exact copy from new-york-v4 ui/textarea.tsx
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-textarea");
            AppendClass(ref cls, "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm");
        });
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Value);
        hc.Add(Placeholder);
        hc.Add(Disabled);
        hc.Add(ReadOnly);
        hc.Add(Required);
        hc.Add(MinLength);
        hc.Add(MaxLength);
        hc.Add(Rows);
    }
}
