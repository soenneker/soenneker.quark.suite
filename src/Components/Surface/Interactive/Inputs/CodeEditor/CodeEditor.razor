@using System.Linq.Expressions
@using System.Text.Json

@namespace Soenneker.Quark
@inherits InputSurfaceElement

@inject ICodeEditorInterop CodeEditorInterop

<div @ref="_container" @attributes="BuildContainerAttributes()"></div>

@code {
    // shadcn - new-york-v4
    /// <summary>
    /// Gets or sets the code text value.
    /// </summary>
    [Parameter]
    public string? Text { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked When the code text changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> TextChanged { get; set; }

    /// <summary>
    /// Gets or sets the expression that identifies the bound text value for validation.
    /// </summary>
    [Parameter]
    public Expression<Func<string?>>? TextExpression { get; set; }

    /// <summary>
    /// Gets or sets the programming language for syntax highlighting.
    /// </summary>
    [Parameter]
    public string Language { get; set; } = "csharp";

    /// <summary>
    /// Gets or sets the editor theme (e.g., "vs", "vs-dark", "hc-black").
    /// </summary>
    [Parameter]
    public string Theme { get; set; } = "vs-dark";

    /// <summary>
    /// Gets or sets whether word wrapping is enabled.
    /// </summary>
    [Parameter]
    public bool WordWrap { get; set; }

    /// <summary>
    /// Gets or sets whether the minimap is displayed.
    /// </summary>
    [Parameter]
    public bool Minimap { get; set; } = true;

    /// <summary>
    /// Gets or sets whether the editor height should automatically adjust to content.
    /// </summary>
    [Parameter]
    public bool AutoHeight { get; set; }

    /// <summary>
    /// Gets or sets the minimum number of lines to display.
    /// </summary>
    [Parameter]
    public int? MinLines { get; set; } = 3;

    /// <summary>
    /// Gets or sets the maximum number of lines to display.
    /// </summary>
    [Parameter]
    public int? MaxLines { get; set; } = 30;

    private ElementReference _container;
    private string? _lastText;
    private string? _lastLanguage;
    private string? _lastTheme;
    private bool _initialized;
    private bool _valueChanged;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CodeEditorInterop.Initialize();

            var options = new
            {
                value = Text ?? string.Empty,
                language = Language,
                theme = Theme,
                readOnly = ReadOnly,
                wordWrap = WordWrap ? "on" : "off",
                minimap = new { enabled = Minimap },
                automaticLayout = true
            };

            var json = JsonSerializer.Serialize(options);
            await CodeEditorInterop.CreateEditor(_container, json);

            // If auto-height is enabled, set up content change listener
            if (AutoHeight)
            {
                await CodeEditorInterop.AddContentChangeListener(_container, MinLines, MaxLines);
            }

            _initialized = true;
            _lastLanguage = Language;
            _lastTheme = Theme;
            _lastText = Text;
        }

        _valueChanged = false;
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override async Task OnParametersSetAsync()
    {
        // Set default width and height if not specified
        Width ??= Soenneker.Quark.Width.Is100;
        
        // Don't set a fixed height if AutoHeight is enabled
        if (!AutoHeight && Height == null && Style == null)
        {
            Style = "height: 300px";
        }

        if (_initialized)
        {
            if (!string.Equals(Text, _lastText, StringComparison.Ordinal))
            {
                await CodeEditorInterop.SetValue(_container, Text ?? string.Empty);
                _lastText = Text;
            }

            if (!string.Equals(Language, _lastLanguage, StringComparison.OrdinalIgnoreCase))
            {
                await CodeEditorInterop.SetLanguage(_container, Language);
                _lastLanguage = Language;
            }

            if (!string.Equals(Theme, _lastTheme, StringComparison.OrdinalIgnoreCase))
            {
                await CodeEditorInterop.SetTheme(Theme);
                _lastTheme = Theme;
            }
        }

        await base.OnParametersSetAsync();
    }

    protected override bool ShouldRender()
    {
        return _valueChanged || base.ShouldRender();
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attrs)
    {
        // Not used on wrapper div; still apply base surface/interactive attributes
        base.BuildAttributesCore(attrs);
    }

    private Dictionary<string, object> BuildContainerAttributes()
    {
        var attrs = new Dictionary<string, object>(base.BuildAttributes());
        // Monaco editor needs position: relative for proper rendering
        BuildStyleAttribute(attrs, (ref sty) =>
        {
            AppendStyleDecl(ref sty, "position: relative");
            AppendStyleDecl(ref sty, "width: 100%");
            AppendStyleDecl(ref sty, "min-width: 0");
        });

        BuildClassAttribute(attrs, (ref cls) =>
        {
            AppendClass(ref cls, "q-code-editor");
        });

        return attrs;
    }

    public override async ValueTask DisposeAsync()
    {
        await base.DisposeAsync();

        if (_initialized)
        {
            await CodeEditorInterop.DisposeEditor(_container);
        }
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Text);
        hc.Add(Language);
        hc.Add(Theme);
        hc.Add(WordWrap);
        hc.Add(Minimap);
        hc.Add(AutoHeight);
        hc.Add(MinLines);
        hc.Add(MaxLines);
    }
}