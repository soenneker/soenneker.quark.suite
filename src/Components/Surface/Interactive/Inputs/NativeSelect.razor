@using Soenneker.Blazor.Extensions.EventCallback

@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements INativeSelect

<div class="group/native-select relative w-fit has-[select:disabled]:opacity-50" data-slot="native-select-wrapper">
    <select value="@Value" @onchange="HandleChange" @attributes="BuildAttributes()">
        @ChildContent
    </select>
    <svg class="text-muted-foreground pointer-events-none absolute top-1/2 right-3.5 size-4 -translate-y-1/2 opacity-50 select-none"
         aria-hidden="true"
         data-slot="native-select-icon"
         xmlns="http://www.w3.org/2000/svg"
         width="24"
         height="24"
         viewBox="0 0 24 24"
         fill="none"
         stroke="currentColor"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round">
        <path d="m6 9 6 6 6-6"></path>
    </svg>
</div>

@code {
    /// <summary>
    /// Gets or sets the selected value.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Gets or sets callback invoked when selected value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets the control size.
    /// </summary>
    [Parameter]
    public NativeSelectSize Size { get; set; } = NativeSelectSize.Default;

    /// <summary>
    /// Gets or sets whether the select is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether the select is required.
    /// </summary>
    [Parameter]
    public bool Required { get; set; }

    private async Task HandleChange(ChangeEventArgs e)
    {
        var next = e.Value?.ToString();
        if (!string.Equals(Value, next, StringComparison.Ordinal))
        {
            Value = next;
            await ValueChanged.InvokeIfHasDelegate(Value);
            InvalidateRender();
            Refresh();
        }
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        attributes["data-slot"] = "native-select";
        attributes["data-size"] = Size == NativeSelectSize.Small ? "sm" : "default";

        if (Disabled)
            attributes["disabled"] = true;

        if (Required)
            attributes["required"] = true;

        // shadcn/ui native-select base - exact copy from new-york-v4 ui/native-select.tsx
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-native-select");
            AppendClass(ref cls, "border-input placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 dark:hover:bg-input/50 h-9 w-full min-w-0 appearance-none rounded-md border bg-transparent px-3 py-2 pr-9 text-sm shadow-xs transition-[color,box-shadow] outline-none disabled:pointer-events-none disabled:cursor-not-allowed data-[size=sm]:h-8 data-[size=sm]:py-1");
            AppendClass(ref cls, "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]");
            AppendClass(ref cls, "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive");
        });
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Value);
        hc.Add(Size);
        hc.Add(Disabled);
        hc.Add(Required);
    }
}
