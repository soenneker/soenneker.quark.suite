@using System.Globalization
@using System.Linq.Expressions
@using Microsoft.JSInterop
@using Soenneker.Blazor.Extensions.EventCallback

@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements Soenneker.Quark.IValidationInput
@implements IDatePicker

<div OnElementRefReady="HandleContainerRefReady" @attributes="GetContainerAttributes()">
    <input @ref="_ref" type="text" value="@(Value.HasValue ? Value.Value.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture) : "")" @attributes="BuildAttributes()" />

    @if (_open)
    {
        <div class="q-date-backdrop" style="position: fixed; inset: 0; z-index: 1075;" @onclick="ClosePanel"></div>
        <div @attributes="BuildPanelAttributes()" @onclick:stopPropagation="true">
            <div class="qcal-header flex items-center justify-between">
                <button type="button" class="qcal-nav inline-flex h-8 items-center justify-center rounded-md border border-input bg-background px-2 text-sm shadow-xs hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" @onclick="PrevMonth">‹</button>
                <div class="qcal-title font-semibold">@_displayMonth.ToString("MMMM yyyy", CultureInfo.CurrentUICulture)</div>
                <button type="button" class="qcal-nav inline-flex h-8 items-center justify-center rounded-md border border-input bg-background px-2 text-sm shadow-xs hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" @onclick="NextMonth">›</button>
            </div>
            <div class="qcal-grid mt-2">
                @foreach (string dow in _dayNames)
                {
                    <div class="qcal-dow text-muted">@dow</div>
                }
                @foreach (Cell day in BuildMonthCells())
                {
                    string css = day.InMonth ? "qcal-day" : "qcal-day text-muted";
                    if (day.Date == DateOnly.FromDateTime(DateTime.Today))
                    {
                        css += " qcal-today";
                    }
                    if (Value.HasValue && day.Date == Value.Value)
                    {
                        css += " qcal-selected";
                    }
                    if (day.Disabled)
                    {
                        css += " disabled";
                    }

                    <button type="button" class="@css" disabled="@day.Disabled" @onclick="() => SelectDate(day.Date)">@day.Date.Day</button>
                }
            </div>
        </div>
    }
</div>

@code {
    // shadcn - new-york-v4

    /// <summary>
    /// Gets or sets the date value.
    /// </summary>
    [Parameter]
    public DateOnly? Value { get; set; }

    /// <summary>
    /// Gets or sets the expression that identifies the bound value.
    /// </summary>
    [Parameter]
    public Expression<Func<DateOnly?>>? ValueExpression { get; set; }

    /// <summary>
    /// Gets or sets the placeholder text.
    /// </summary>
    [Parameter]
    public string? Placeholder { get; set; }

    /// <summary>
    /// Gets or sets whether the date picker is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether the date picker is read-only.
    /// </summary>
    [Parameter]
    public bool ReadOnly { get; set; }

    /// <summary>
    /// Gets or sets whether the date picker is required.
    /// </summary>
    [Parameter]
    public bool Required { get; set; }

    /// <summary>
    /// Gets or sets the minimum date value.
    /// </summary>
    [Parameter]
    public DateOnly? Min { get; set; }

    /// <summary>
    /// Gets or sets the maximum date value.
    /// </summary>
    [Parameter]
    public DateOnly? Max { get; set; }

    /// <summary>
    /// Gets or sets the size of the date picker.
    /// </summary>
    [Parameter]
    public CssValue<SizeBuilder>? Size { get; set; } = Quark.Size.Default;

    /// <summary>
    /// Gets or sets the callback invoked When the value changes.
    /// </summary>
    [Parameter]
    public EventCallback<DateOnly?> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked When the input changes.
    /// </summary>
    [Parameter]
    public EventCallback<ChangeEventArgs> OnChange { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked When the input value changes.
    /// </summary>
    [Parameter]
    public EventCallback<ChangeEventArgs> OnInput { get; set; }

    [CascadingParameter(Name = nameof(ParentValidation))]
    public Validation? ParentValidation { get; set; }

    /// <summary>
    /// Gets the value used for validation.
    /// </summary>
    public object? ValidationValue => Value;

    private ElementReference _ref;
    private ElementReference _containerRef;
    private DotNetObjectReference<DatePickerOutsideCloseProxy>? _outsideRef;
    private bool _open;
    private DateOnly _displayMonth = DateOnly.FromDateTime(DateTime.Today);
    private string[] _dayNames = [];

    private static DateOnly? Parse(ChangeEventArgs e)
    {
        if (e?.Value == null)
            return null;

        var text = e.Value.ToString();
        if (DateOnly.TryParseExact(text, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out DateOnly result))
            return result;

        return null;
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        DateOnly? next = Parse(e);
        bool valueChanged = Value != next;
        Value = next;
        if (valueChanged)
            await ValueChanged.InvokeIfHasDelegate(Value);
        await OnInput.InvokeIfHasDelegate(e);

        if (ParentValidation is not null)
            await ParentValidation.NotifyInputChanged(Value);

        if (valueChanged)
        {
            InvalidateRender();
            Refresh();
        }
    }

    private async Task HandleChange(ChangeEventArgs e)
    {
        DateOnly? next = Parse(e);
        bool valueChanged = Value != next;
        Value = next;
        if (valueChanged)
            await ValueChanged.InvokeIfHasDelegate(Value);
        await OnChange.InvokeIfHasDelegate(e);

        if (ParentValidation is not null)
            await ParentValidation.NotifyInputChanged(Value);

        if (valueChanged)
        {
            InvalidateRender();
            Refresh();
        }
    }

    private string? GetSizeClass()
    {
        if (Size == Quark.Size.Default) return null;
        string? token = null;
        bool isTheme = Size?.TryGetThemeToken(out token) == true;
        var sizeVal = token ?? Size?.ToString();
        return sizeVal?.ToLowerInvariant() switch { "sm" or "xs" => "h-9 text-xs", "lg" => "h-11 text-base", _ => null };
    }


    private string? GetValidationClass()
    {
        if (ParentValidation?.Status == ValidationStatus.Error)
            return "is-invalid";

        if (ParentValidation?.Status == ValidationStatus.Success)
            return "is-valid";

        return null;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ParentValidation is not null)
        {
            await ParentValidation.InitializeInput(this);

            if (ValueExpression is not null)
            {
                await ParentValidation.InitializeInputExpression(ValueExpression);
            }
        }


        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            _outsideRef = DotNetObjectReference.Create(new DatePickerOutsideCloseProxy(this));
            InitializeDayNames();
            if (Value.HasValue)
                _displayMonth = new DateOnly(Value.Value.Year, Value.Value.Month, 1);
            else
                _displayMonth = new DateOnly(DateOnly.FromDateTime(DateTime.Today).Year, DateOnly.FromDateTime(DateTime.Today).Month, 1);
        }
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-date-picker");
            AppendClass(ref cls, "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 transition-colors md:text-sm");
            
            string? sizeClass = GetSizeClass();
            if (sizeClass != null)
                AppendClass(ref cls, sizeClass);
                
            string? validationClass = GetValidationClass();
            if (validationClass != null)
                AppendClass(ref cls, validationClass);
        });

        if (Placeholder.HasContent())
            attributes["placeholder"] = Placeholder!;

        if (Disabled)
            attributes["disabled"] = true;

        if (ReadOnly)
            attributes["readonly"] = true;

        if (Required)
            attributes["required"] = true;

        // min/max intentionally omitted for text input (handled in panel)

        attributes["onclick"] = EventCallback.Factory.Create<MouseEventArgs>(this, OpenPanel);
        attributes["onfocus"] = EventCallback.Factory.Create<FocusEventArgs>(this, OpenPanel);

        attributes["autocomplete"] = "off";
        attributes["oninput"] = EventCallback.Factory.Create<ChangeEventArgs>(this, HandleInput);
        attributes["onchange"] = EventCallback.Factory.Create<ChangeEventArgs>(this, HandleChange);
    }

    private Task HandleContainerRefReady(ElementReference el)
    {
        _containerRef = el;
        return Task.CompletedTask;
    }

    private Dictionary<string, object> GetContainerAttributes()
    {
        var attrs = new Dictionary<string, object>(2);
        BuildClassAttribute(attrs, (ref cls) =>
        {
            AppendClass(ref cls, "relative inline-block q-date-container");
        });
        return attrs;
    }

    private Dictionary<string, object> BuildPanelAttributes()
    {
        var attrs = new Dictionary<string, object>(4);
        BuildClassAttribute(attrs, (ref cls) =>
        {
            AppendClass(ref cls, "q-calendar-panel");
            AppendClass(ref cls, "shadow-lg border rounded-lg bg-background p-3");
        });
        BuildStyleAttribute(attrs, (ref sty) =>
        {
            AppendStyleDecl(ref sty, "position: absolute");
            AppendStyleDecl(ref sty, "top: calc(100% + .25rem)");
            AppendStyleDecl(ref sty, "left: 0");
            AppendStyleDecl(ref sty, "z-index: 1080");
            AppendStyleDecl(ref sty, "min-width: 18rem");
        });
        return attrs;
    }

    private void InitializeDayNames()
    {
        CultureInfo culture = CultureInfo.CurrentCulture;
        DayOfWeek first = culture.DateTimeFormat.FirstDayOfWeek;
        string[] names = culture.DateTimeFormat.AbbreviatedDayNames;
        _dayNames = Enumerable.Range(0, 7)
            .Select(i => names[((int)first + i) % 7])
            .ToArray();
    }

    private readonly record struct Cell(DateOnly Date, bool InMonth, bool Disabled);

    private IEnumerable<Cell> BuildMonthCells()
    {
        var firstOfMonth = new DateOnly(_displayMonth.Year, _displayMonth.Month, 1);
        CultureInfo culture = CultureInfo.CurrentCulture;
        DayOfWeek startDow = culture.DateTimeFormat.FirstDayOfWeek;
        int offset = ((int)firstOfMonth.DayOfWeek - (int)startDow + 7) % 7;
        DateOnly gridStart = firstOfMonth.AddDays(-offset);

        for (var i = 0; i < 42; i++)
        {
            DateOnly d = gridStart.AddDays(i);
            bool inMonth = d.Month == _displayMonth.Month;
            bool disabled = (Min.HasValue && d < Min.Value) || (Max.HasValue && d > Max.Value);
            yield return new Cell(d, inMonth, disabled);
        }
    }

    private Task OpenPanel()
    {
        if (!_open)
            _open = true;
        InvalidateRender();
        Refresh();
        return Task.CompletedTask;
    }

    internal async Task ClosePanel()
    {
        if (_open)
            _open = false;
        await RefreshOffThread();
    }


    private async Task SelectDate(DateOnly date)
    {
        if ((Min.HasValue && date < Min.Value) || (Max.HasValue && date > Max.Value))
            return;

        if (Value != date)
        {
            Value = date;
            await ValueChanged.InvokeAsync(Value);
        }
        
        if (ParentValidation is not null)
        {
            ParentValidation.MarkTouched();
            await ParentValidation.NotifyInputChanged(Value);
        }
        
        await ClosePanel();
    }

    private Task PrevMonth()
    {
        _displayMonth = _displayMonth.AddMonths(-1);
        InvalidateRender();
        Refresh();
        return Task.CompletedTask;
    }

    private Task NextMonth()
    {
        _displayMonth = _displayMonth.AddMonths(1);
        InvalidateRender();
        Refresh();
        return Task.CompletedTask;
    }

    protected override Task OnDisposeAsync()
    {
        _outsideRef?.Dispose();
        return Task.CompletedTask;
    }

    protected override void ApplyBackgroundColor(ref PooledStringBuilder sty, ref PooledStringBuilder cls)
    {
        if (BackgroundColor is { IsEmpty: false })
        {
            string? token = null;
            bool isTheme = BackgroundColor.Value.TryGetThemeToken(out token);

            var result = BackgroundColor.Value.ToString();
            if (!result.HasContent()) return;

            if (BackgroundColor.Value.IsCssStyle)
                AppendStyleDecl(ref sty, $"background-color: {result}");
        }
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Value);
        hc.Add(Placeholder);
        hc.Add(Disabled);
        hc.Add(ReadOnly);
        hc.Add(Required);
        hc.Add(Min);
        hc.Add(Max);
        AddIf(ref hc, Size);
    }
}