@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements IProgressBar

<div @attributes="BuildAttributes()">
    @if (ShowLabel)
    {
        @($"{Value}%")
    }
    @ChildContent
</div>

@code {

    [Parameter]
    public new RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Gets or sets the progress value (0-100).
    /// </summary>
    [Parameter]
    public int Value { get; set; }

    /// <summary>
    /// Gets or sets whether the progress bar should be striped.
    /// </summary>
    [Parameter]
    public bool Striped { get; set; }

    /// <summary>
    /// Gets or sets whether the progress bar should be animated.
    /// </summary>
    [Parameter]
    public bool Animated { get; set; }

    /// <summary>
    /// Gets or sets whether to show the label with the percentage.
    /// </summary>
    [Parameter]
    public bool ShowLabel { get; set; } = true;

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        string? bgClass = null;
        if (BackgroundColor is not null && !BackgroundColor.Value.IsEmpty)
        {
            string v = BackgroundColor.Value.ToString().Trim();
            if (BackgroundColor.Value.IsCssClass)
            {
                bgClass = v.StartsWith("bg-", StringComparison.Ordinal) ? v : $"bg-{v}";
            }
        }

        // shadcn Progress indicator - new-york-v4 ui/progress.tsx
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-progress-bar");
            AppendClass(ref cls, "bg-primary h-full w-full flex-1 transition-all rounded-full");
            if (Striped)
                AppendClass(ref cls, "bg-gradient-to-r from-primary via-primary/80 to-primary bg-[length:1rem_1rem]");
            if (Animated)
                AppendClass(ref cls, "animate-pulse");
            if (bgClass != null)
                AppendClass(ref cls, bgClass);
        });

        int clamped = Math.Clamp(Value, 0, 100);
        BuildStyleAttribute(attributes, (ref sty) => AppendStyleDecl(ref sty, $"transform: translateX(-{100 - clamped}%);"));
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Value);
        hc.Add(Striped);
        hc.Add(Animated);
        hc.Add(ShowLabel);
    }
}