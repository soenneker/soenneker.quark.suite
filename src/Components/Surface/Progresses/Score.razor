@using System.Globalization

@namespace Soenneker.Quark
@inherits Soenneker.Quark.CancellableElement
@implements IScore
@inject IScoreInterop ScoreInterop

<div @attributes="BuildAttributes()" role="progressbar" aria-valuenow="@_normalizedValue" aria-valuemin="0" aria-valuemax="100">
    <div class="q-score-circle">
        <div class="q-score-center">
            <div class="q-score-value">@_normalizedValue</div>
        </div>
    </div>
    @if (ChildContent != null)
    {
        <div class="q-score-text">@ChildContent</div>
    }
    else if (Text.HasContent())
    {
        <div class="q-score-text">@Text</div>
    }
</div>

@code
{
    // shadcn - new-york-v4
    private static readonly CultureInfo _inv = CultureInfo.InvariantCulture;

    private bool _initialized;
    private bool _parametersChanged;

    private int _normalizedValue;
    private int _lastValue;
    private string? _lastText;
    private int _lastSize;
    private int _lastThickness;

    // Cached computed values (only recomputed when params actually change)
    private int _sizePx;
    private int _thicknessPx;
    private string _angleCss = "0deg";
    private string _colorCss = "hsl(0 75% 45%)";
    private string _sizeCss = "88px";
    private string _thicknessCss = "8px";

    [Parameter] public int Value { get; set; }
    [Parameter] public string? Text { get; set; }
    [Parameter] public int Size { get; set; } = 88;
    [Parameter] public int Thickness { get; set; } = 8;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            await ScoreInterop.Initialize(CancellationToken);
            _initialized = true;
        }

        _parametersChanged = false;
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override void OnParametersSet()
    {
        _normalizedValue = NormalizeValue(Value);

        _parametersChanged =
            _normalizedValue != _lastValue ||
            Size != _lastSize ||
            Thickness != _lastThickness ||
            !string.Equals(Text, _lastText, StringComparison.Ordinal);

        if (_parametersChanged)
        {
            _sizePx = Size <= 0 ? 88 : Size;
            _thicknessPx = Thickness <= 0 ? 8 : Thickness;

            _sizeCss = string.Concat(_sizePx.ToString(_inv), "px");
            _thicknessCss = string.Concat(_thicknessPx.ToString(_inv), "px");

            // angle = value * 3.6
            _angleCss = string.Concat(FormatDouble0To2(_normalizedValue * 3.6d), "deg");

            // hue: 0..120, split ramp around 50
            double hue = _normalizedValue <= 50
                ? (_normalizedValue / 50d) * 60d
                : 60d + ((_normalizedValue - 50d) / 50d) * 60d;

            // hsl(<hue> 75% 45%)
            _colorCss = string.Concat("hsl(", FormatDouble0To2(hue), " 75% 45%)");
        }

        _lastValue = _normalizedValue;
        _lastSize = Size;
        _lastThickness = Thickness;
        _lastText = Text;

        base.OnParametersSet();
    }

    protected override bool ShouldRender() => _parametersChanged || base.ShouldRender();

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAndStyleAttributes(attributes, (ref cls, ref sty) =>
        {
            AppendClass(ref cls, "q-score");

            // Use cached strings so this method stays cheap.
            AppendStyleDecl(ref sty, "--q-score-angle: ", _angleCss);
            AppendStyleDecl(ref sty, "--q-score-color: ", _colorCss);
            AppendStyleDecl(ref sty, "--q-score-size: ", _sizeCss);
            AppendStyleDecl(ref sty, "--q-score-thickness: ", _thicknessCss);
        });
    }

    private static int NormalizeValue(int value) => Math.Clamp(value, 0, 100);

    // Fast invariant formatting without allocating intermediary strings in common cases.
    private static string FormatDouble0To2(double value)
    {
        Span<char> buffer = stackalloc char[32];

        // "0.##" keeps output short (same as your original intent)
        if (value.TryFormat(buffer, out int written, "0.##", _inv))
            return new string(buffer[..written]);

        return value.ToString("0.##", _inv);
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Value);
        hc.Add(Text);
        hc.Add(Size);
        hc.Add(Thickness);
    }
}