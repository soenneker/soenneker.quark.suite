@namespace Soenneker.Quark

@inherits Soenneker.Quark.Element
@implements ICollapse

<div @attributes="BuildAttributes()">
    @ChildContent
</div>

@code {
    /// <summary>
    /// Gets a stable ID for this collapse element that can be referenced by toggles.
    /// If not provided via <see cref="Id"/>, one will be generated.
    /// </summary>
    public string CollapseId => Id.HasContent() ? Id! : _autoId ??= $"collapse_{Guid.NewGuid():N}";

    /// <summary>
    /// Gets or sets whether the collapse is expanded.
    /// </summary>
    [Parameter]
    public bool Expanded { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the expanded state changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> OnExpandedChanged { get; set; }

    /// <summary>
    /// Gets or sets whether the collapse should expand horizontally.
    /// </summary>
    [Parameter]
    public bool Horizontal { get; set; }

    /// <summary>
    /// Toggles the expanded state of the collapse.
    /// </summary>
    /// <returns>A task representing the toggle operation.</returns>
    public async Task Toggle()
    {
        Expanded = !Expanded;
        _forceRender = true;
        
        if (OnExpandedChanged.HasDelegate)
        {
            await OnExpandedChanged.InvokeAsync(Expanded);
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Shows (expands) the collapse.
    /// </summary>
    /// <returns>A task representing the show operation.</returns>
    public async Task Show()
    {
        if (!Expanded)
        {
            Expanded = true;
            _forceRender = true;
            
            if (OnExpandedChanged.HasDelegate)
            {
                await OnExpandedChanged.InvokeAsync(Expanded);
            }
            
            StateHasChanged();
        }
    }

    /// <summary>
    /// Hides (collapses) the collapse.
    /// </summary>
    /// <returns>A task representing the hide operation.</returns>
    public async Task Hide()
    {
        if (Expanded)
        {
            Expanded = false;
            _forceRender = true;
            
            if (OnExpandedChanged.HasDelegate)
            {
                await OnExpandedChanged.InvokeAsync(Expanded);
            }
            
            StateHasChanged();
        }
    }

    private bool _lastExpanded;
    private bool _expandedChanged;
    private bool _forceRender;

    protected override void OnParametersSet()
    {
        // Track param-driven expanded changes so we can render even if base gate blocks it
        _expandedChanged |= Expanded != _lastExpanded;
        _lastExpanded = Expanded;
        base.OnParametersSet();
    }

    protected override bool ShouldRender()
    {
        // Allow render when Expanded changes or when we explicitly request it
        return _forceRender || _expandedChanged || base.ShouldRender();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _forceRender = false;
        _expandedChanged = false;
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-collapse");
            AppendClass(ref cls, "collapse");
            
            if (Horizontal)
                AppendClass(ref cls, "collapse-horizontal");
            if (Expanded)
                AppendClass(ref cls, "show");
        });

        // Ensure an id exists so controls can target this collapse per Bootstrap docs
        if (!Id.HasContent())
            Id = _autoId ??= $"collapse_{Guid.NewGuid():N}";

        attributes["id"] = Id!;
    }

    

    private string? _autoId;

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Expanded);
        hc.Add(Horizontal);
        hc.Add(Id);
    }
}