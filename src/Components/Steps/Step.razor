@namespace Soenneker.Quark
@using Soenneker.Utils.PooledStringBuilders

@inherits Soenneker.Quark.Element
@implements IStep

<UnorderedListItem Class="@GetStepClasses()">
    <Anchor To="@GetHref()" Class="@GetStepLinkClasses()" OnClick="@(IsClickable ? HandleStepClick : null)" role="tab" aria-selected="@(Active ? "true" : "false")" aria-current="@(Active ? "step" : null)" @attributes="BuildAttributes()">
        <Div Class="@GetMarkerClasses()">
            @if (Marker != null)
            {
                @Marker
            }
            else
            {
                @if (Completed)
                {
                    <Span>âœ“</Span>
                }
                else if (Index.HasValue)
                {
                    <Span>@Index.Value</Span>
                }
                else
                {
                    <Span>@CalculatedIndex</Span>
                }
            }
        </Div>
        
        @if (Caption != null || Title.HasContent())
        {
            <Div Class="@GetDescriptionClasses()">
                @if (Caption != null)
                {
                    @Caption
                }
                else
                {
                    @if (Title.HasContent())
                    {
                        <Div Class="step-title">@Title</Div>
                    }
                    @ChildContent
                }
            </Div>
        }
        else
        {
            @ChildContent
        }
    </Anchor>
</UnorderedListItem>

@code {
    public override string? ThemeKey { get; set; } = "Step";

    [Parameter]
    public string? Name { get; set; }

    private StepsState? _parentStepsState;

    [Parameter]
    public int? Index { get; set; }

    [Parameter]
    public bool Completed { get; set; }

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public EventCallback<MouseEventArgs> Clicked { get; set; }

    [Parameter]
    public RenderFragment? Marker { get; set; }

    [Parameter]
    public RenderFragment? Caption { get; set; }

    [CascadingParameter]
    public StepsState? ParentStepsState
    {
        get => _parentStepsState;
        set
        {
            if (_parentStepsState == value)
                return;

            _parentStepsState = value;
            AriaDescribedBy = _parentStepsState?.SelectedStep;
            StateHasChanged();
            
        }
    }

    [CascadingParameter]
    public Steps? ParentSteps { get; set; }

    private bool Active 
    { 
        get 
        {
            var isActive = _parentStepsState?.SelectedStep == Name && !string.IsNullOrEmpty(Name);
            return isActive;
        }
    }

    private bool IsClickable => Clicked.HasDelegate;

    private int CalculatedIndex => Index ?? ParentSteps?.IndexOfStep(Name ?? string.Empty) ?? 1;

    private static string GetStepClasses()
    {
        var attributes = new Dictionary<string, object>();
        AppendToClassAttr(attributes, "step-item");
        return attributes.TryGetValue("class", out var classValue) ? classValue.ToString() ?? string.Empty : string.Empty;
    }

    private string GetStepLinkClasses()
    {
        var attributes = new Dictionary<string, object>();
        
        // Use custom styling instead of Bootstrap classes
        if (Active)
        {
            AppendToClassAttr(attributes, "active");
        }

        if (Completed)
            AppendToClassAttr(attributes, "text-success");

        if (Disabled)
            AppendToClassAttr(attributes, "disabled");

        if (!IsClickable)
            AppendToClassAttr(attributes, "non-clickable");

        return attributes.TryGetValue("class", out var classValue) ? classValue.ToString() ?? string.Empty : string.Empty;
    }

    private string GetMarkerClasses()
    {
        var attributes = new Dictionary<string, object>();
        
        AppendToClassAttr(attributes, "step-marker");

        if (Active)
            AppendToClassAttr(attributes, "step-marker-active");

        return attributes.TryGetValue("class", out var classValue) ? classValue.ToString() ?? string.Empty : string.Empty;
    }

    private static string GetDescriptionClasses()
    {
        return "step-description";
    }

    private string? GetHref()
    {
        return Name.HasContent() ? $"#{Name}" : null;
    }

    private async Task HandleStepClick(MouseEventArgs args)
    {
        await Clicked.InvokeAsync(args);

        if (ParentSteps != null && Name.HasContent())
        {
            await ParentSteps.SelectStep(Name);
        }
    }

    protected override void OnInitialized()
    {
        ParentSteps?.NotifyStepInitialized(Name ?? string.Empty);
        base.OnInitialized();
    }

    public override void Dispose()
    {
        ParentSteps?.NotifyStepRemoved(Name ?? string.Empty);
    }

    protected override void ApplyBackgroundColor(ref PooledStringBuilder sty, ref PooledStringBuilder cls)
    {
        if (BackgroundColor is { IsEmpty: false })
        {
            string? token = null;
            var isTheme = BackgroundColor.Value.TryGetBootstrapThemeToken(out token);

            if (isTheme && token is not null)
            {
                AppendClass(ref cls, $"step-marker-{token}");
            }
            else
            {
                var result = BackgroundColor.ToString();
                if (!result.HasContent()) return;

                if (BackgroundColor.Value.IsCssStyle)
                    AppendStyleDecl(ref sty, $"background-color: {result}");
                else
                    AppendClass(ref cls, $"step-marker-{result}");
            }
        }
    }
}
