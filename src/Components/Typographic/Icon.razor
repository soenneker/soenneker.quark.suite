@using System.Runtime.CompilerServices

@namespace Soenneker.Quark
@inherits Soenneker.Quark.TypographicElement
@implements IIcon

<i @attributes="BuildAttributes()" ></i>

@code {
    /// <summary>
    /// Gets or sets the name of the icon (e.g., "camera" or "fa-camera").
    /// </summary>
    [Parameter]
    public string? Name { get; set; } // "camera" or "fa-camera"

    /// <summary>
    /// Gets or sets the style of the icon (e.g., fa-regular, fa-solid, fa-light, fa-thin, fa-duotone, fa-brands).
    /// </summary>
    [Parameter]
    public IconStyle? IconStyle { get; set; }

    /// <summary>
    /// Gets or sets the icon family (e.g., Classic, Sharp, SharpDuotone, Chisel, Etch, Jelly, etc.).
    /// </summary>
    [Parameter]
    public IconFamily? Family { get; set; }

    /// <summary>
    /// Gets or sets the size of the icon (e.g., fa-xs, fa-sm, fa-lg, fa-2x).
    /// </summary>
    [Parameter]
    public IconSize? IconSize { get; set; }

    /// <summary>
    /// Gets or sets the CSS size value for the icon.
    /// </summary>
    [Parameter]
    public CssValue<SizeBuilder>? Size { get; set; }

    /// <summary>
    /// Gets or sets whether the icon should spin in reverse.
    /// </summary>
    [Parameter]
    public bool SpinReverse { get; set; }

    /// <summary>
    /// Gets or sets the rotation of the icon.
    /// </summary>
    [Parameter]
    public IconRotate? Rotate { get; set; }

    /// <summary>
    /// Gets or sets the rotation angle in degrees.
    /// </summary>
    [Parameter]
    public int? RotateByDegrees { get; set; }

    /// <summary>
    /// Gets or sets the flip direction of the icon.
    /// </summary>
    [Parameter]
    public IconFlip? Flip { get; set; }

    /// <summary>
    /// Gets or sets the animation of the icon.
    /// </summary>
    [Parameter]
    public IconAnimation? IconAnimation { get; set; }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAndStyleAttributes(attributes, (ref cls, ref sty) =>
        {
            AppendClass(ref cls, "q-icon");
            AppendClass(ref cls, "fa");

            var styleClass = GetFamilyAndStyleClass(Family, IconStyle);

            if (styleClass.HasContent())
                AppendClass(ref cls, styleClass);

            if (Name.HasContent())
                AppendClass(ref cls, NormalizeIconName(Name!));

            if (IconSize is not null && IconSize != IconSize.None)
                AppendClass(ref cls, IconSize!.Value);

            if (SpinReverse)
                AppendClass(ref cls, "fa-spin-reverse");

            if (Rotate is not null && Rotate != IconRotate.None)
                AppendClass(ref cls, Rotate!.Value);

            if (Flip is not null && Flip != IconFlip.None)
                AppendClass(ref cls, Flip!.Value);

            if (Animation is not null && Animation != IconAnimation.None)
                AppendClass(ref cls, Animation!.Value);

            AddCss(ref sty, ref cls, Size);
        });

        if (RotateByDegrees.HasValue)
            BuildStyleAttribute(attributes, (ref sty) => AppendStyleDecl(ref sty, $"--fa-rotate-angle: {RotateByDegrees.Value}deg"));
    }

    

    private static string GetFamilyAndStyleClass(IconFamily? family, IconStyle? weight)
    {
        var fam = family?.Value ?? string.Empty; // e.g., "fa-sharp", "fa-jelly-duo"
        var w = weight?.Value ?? string.Empty; // e.g., "fa-regular", "fa-solid"

        // Brands: ignore family completely
        if (w == "fa-brands")
            return w;

        // If family is empty (Classic case) → just return the weight
        if (fam.Length == 0)
            return w;

        // If weight is duotone and family is sharp/chisel → collapse into fused token
        if (w == "fa-duotone" && (fam == "fa-sharp" || fam == "fa-chisel"))
            return $"{fam}-duotone";

        // Otherwise: family + optional weight
        return w.HasContent() ? $"{fam} {w}" : fam;
    }

    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    private static string NormalizeIconName(string icon) => icon.StartsWith("fa-", StringComparison.Ordinal) ? icon : $"fa-{icon}";

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Name);
        hc.Add(IconStyle);
        hc.Add(Family);
        hc.Add(IconSize);
        AddIf(ref hc, Size);
        hc.Add(SpinReverse);
        hc.Add(Rotate);
        hc.Add(RotateByDegrees);
        hc.Add(Flip);
        hc.Add(IconAnimation);
    }
}