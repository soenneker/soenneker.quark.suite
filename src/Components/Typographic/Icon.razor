@using System.Runtime.CompilerServices

@namespace Soenneker.Quark
@inherits Soenneker.Quark.TypographicElement
@implements IIcon

<i @attributes="BuildAttributes()" ></i>

@code {
    public override string? ThemeKey { get; set; } = "Icon";

    [Parameter]
    public string? Name { get; set; } // "camera" or "fa-camera"

    // Classic FA weights: fa-regular, fa-solid, fa-light, fa-thin, fa-duotone, fa-brands
    // (If you prefer geometry+weight, you can keep passing e.g. "fa-regular")
    [Parameter]
    public IconStyle? IconStyle { get; set; }

    // FA7 "Icon Family" (Classic, Sharp, SharpDuotone, Chisel, Etch, Jelly, Notdog, Slab, Thumbprint, Whiteboard…)
    [Parameter]
    public IconFamily? Family { get; set; }

    // Optional FA size helpers (fa-xs, fa-sm, fa-lg, fa-2x …)
    [Parameter]
    public IconSize? IconSize { get; set; }

    [Parameter]
    public CssValue<SizeBuilder>? Size { get; set; }

    [Parameter]
    public bool SpinReverse { get; set; }

    [Parameter]
    public IconRotate? Rotate { get; set; }

    [Parameter]
    public int? RotateByDegrees { get; set; }

    [Parameter]
    public IconFlip? Flip { get; set; }

    [Parameter]
    public IconAnimation? IconAnimation { get; set; }

    protected override Dictionary<string, object> BuildAttributes()
    {
        var attributes = base.BuildAttributes();

        BuildClassAttribute(attributes, (ref PooledStringBuilder cls) =>
        {
            AppendClass(ref cls, "fa");

            var styleClass = GetFamilyAndStyleClass(Family, IconStyle);

            if (styleClass.HasContent())
                AppendClass(ref cls, styleClass);

            if (Name.HasContent())
                AppendClass(ref cls, NormalizeIconName(Name!));

            if (IconSize is not null && IconSize != IconSize.None)
                AppendClass(ref cls, IconSize!.Value);

            if (SpinReverse)
                AppendClass(ref cls, "fa-spin-reverse");

            if (Rotate is not null && Rotate != IconRotate.None)
                AppendClass(ref cls, Rotate!.Value);

            if (Flip is not null && Flip != IconFlip.None)
                AppendClass(ref cls, Flip!.Value);

            if (Animation is not null && Animation != IconAnimation.None)
                AppendClass(ref cls, Animation!.Value);
        });

        if (RotateByDegrees.HasValue)
            BuildStyleAttribute(attributes, (ref PooledStringBuilder sty) => AppendStyleDecl(ref sty, $"--fa-rotate-angle: {RotateByDegrees.Value}deg"));

        return attributes;
    }

    private static string GetFamilyAndStyleClass(IconFamily? family, IconStyle? weight)
    {
        var fam = family?.Value ?? string.Empty; // e.g., "fa-sharp", "fa-jelly-duo"
        var w = weight?.Value ?? string.Empty; // e.g., "fa-regular", "fa-solid"

        // Brands: ignore family completely
        if (w == "fa-brands")
            return w;

        // If family is empty (Classic case) → just return the weight
        if (fam.Length == 0)
            return w;

        // If weight is duotone and family is sharp/chisel → collapse into fused token
        if (w == "fa-duotone" && (fam == "fa-sharp" || fam == "fa-chisel"))
            return $"{fam}-duotone";

        // Otherwise: family + optional weight
        return w.HasContent() ? $"{fam} {w}" : fam;
    }

    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    private static string NormalizeIconName(string icon) => icon.StartsWith("fa-", StringComparison.Ordinal) ? icon : $"fa-{icon}";

}

