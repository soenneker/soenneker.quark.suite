@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements IPreCode

<pre @attributes="BuildPreAttributes()">
    <code @attributes="BuildCodeAttributes()">
        @ChildContent
    </code>
</pre>

@code {
    [Parameter]
    public string? Language { get; set; }

    [Parameter]
    public bool Highlight { get; set; } = true;

    [Parameter]
    public string? Theme { get; set; } = "default";

    [Parameter]
    public bool Scrollable { get; set; } = true;

    protected virtual Dictionary<string, object> BuildPreAttributes()
    {
        var attributes = new Dictionary<string, object>();

        // Add default Bootstrap classes for pre element
        if (!Class.HasContent())
        {
            var baseClasses = "q-pre-code text-bg-light p-3 rounded";
            
            if (Scrollable)
            {
                baseClasses += " overflow-auto";
            }

            if (MaxHeight.HasValue)
            {
                attributes["style"] = $"max-height: {MaxHeight.Value}px;";
            }

            attributes["class"] = baseClasses;
        }
        else
        {
            var currentClass = Class;
            
            if (Scrollable && !currentClass.Contains("overflow-auto"))
            {
                currentClass = AppendToClass(currentClass, "overflow-auto");
            }

            attributes["class"] = currentClass;
        }

        return attributes;
    }

    protected virtual Dictionary<string, object> BuildCodeAttributes()
    {
        var attributes = new Dictionary<string, object>();

        if (Language.HasContent())
            attributes["Language"] = Language;

        if (Theme.HasContent() && Theme != "default")
            attributes["Theme"] = Theme;

        if (Highlight)
            attributes["Highlight"] = Highlight;

        attributes["Inline"] = false;

        return attributes;
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Language);
        hc.Add(Highlight);
        hc.Add(Theme);
        hc.Add(Scrollable);
    }
}
