@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements IBarDropdownMenu

<div id="@ParentDropdown?.CollapseId" data-bs-parent="@CollapseParent" @attributes="BuildAttributes()">
    <div class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
        @ChildContent
    </div>
</div>

@code {
    /// <summary>
    /// Gets or sets whether the dropdown menu should be shown.
    /// </summary>
    [Parameter]
    public bool Show { get; set; }

    /// <summary>
    /// Gets or sets whether the dropdown menu should be right-aligned.
    /// </summary>
    [Parameter]
    public bool RightAligned { get; set; }

    [CascadingParameter(Name = nameof(Mode))]
    public BarMode Mode { get; set; } = BarMode.Horizontal;

    [CascadingParameter(Name = nameof(ParentDropdown))]
    public BarDropdown? ParentDropdown { get; set; }

    [CascadingParameter(Name = nameof(VerticalBarCollapsed))]
    public bool VerticalBarCollapsed { get; set; }

    [CascadingParameter(Name = nameof(CollapseParent))]
    public string? CollapseParent { get; set; }
    
    [CascadingParameter(Name = nameof(ForceCollapseAll))]
    public bool ForceCollapseAll { get; set; }

    protected override bool ShouldRender()
    {
        // For vertical bars, always render when sidebar collapse state might change
        // The base component's render key doesn't track cascading parameters
        if (Mode != BarMode.Horizontal)
        {
            return true;
        }

        return base.ShouldRender();
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        bool shouldShow = Show && !VerticalBarCollapsed && !ForceCollapseAll;

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-bar-dropdown-menu");
            AppendClass(ref cls, "collapse");
            
            if (shouldShow)
                AppendClass(ref cls, "show");
        });
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Show);
        hc.Add(RightAligned);
        hc.Add(Mode);
        hc.Add(VerticalBarCollapsed);
        hc.Add(CollapseParent);
        hc.Add(ForceCollapseAll);
        if (ParentDropdown?.CollapseId is not null)
            hc.Add(ParentDropdown.CollapseId);
    }
}