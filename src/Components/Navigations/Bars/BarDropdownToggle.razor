@namespace Soenneker.Quark

@inherits Soenneker.Quark.Element
@implements IBarDropdownToggle

<button @attributes="BuildAttributes()" aria-expanded="@((!ForceCollapseAll && Expanded).ToString().ToLower())" aria-controls="@TargetId">
    @ChildContent
</button>

@code {
    /// <summary>
    /// Gets or sets the callback invoked when the dropdown toggle is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<MouseEventArgs> OnToggle { get; set; }

    /// <summary>
    /// Gets or sets whether the toggle is disabled.
    /// </summary>
    [Parameter]
    public bool? Disabled { get; set; }

    /// <summary>
    /// Gets or sets the indentation level for the dropdown toggle.
    /// </summary>
    [Parameter]
    public double Indentation { get; set; } = 1.5d;

    /// <summary>
    /// Gets or sets whether the dropdown is expanded.
    /// </summary>
    [Parameter]
    public bool Expanded { get; set; }

    [CascadingParameter(Name = nameof(Mode))]
    public BarMode Mode { get; set; } = BarMode.Horizontal;

    [CascadingParameter(Name = nameof(ParentDropdown))]
    public BarDropdown? ParentDropdown { get; set; }

    [CascadingParameter(Name = nameof(VerticalBarCollapsed))]
    public bool VerticalBarCollapsed { get; set; }
    
    [CascadingParameter(Name = nameof(ForceCollapseAll))]
    public bool ForceCollapseAll { get; set; }


    private string TargetId => ParentDropdown?.CollapseId ?? "";

    protected override bool ShouldRender()
    {
        // For vertical bars, always render when sidebar collapse state might change
        // The base component's render key doesn't track cascading parameters
        if (Mode != BarMode.Horizontal)
        {
            return true;
        }

        return base.ShouldRender();
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-bar-dropdown-toggle");
            AppendClass(ref cls, "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 cursor-pointer");
            AppendClass(ref cls, "rounded items-center");
            
            bool shouldBeCollapsed = ForceCollapseAll || !Expanded;
            if (shouldBeCollapsed)
                AppendClass(ref cls, "aria-expanded:rotate-0");
            
            if (Disabled == true)
                AppendClass(ref cls, "opacity-50 cursor-not-allowed pointer-events-none");

            if (Mode != BarMode.Horizontal)
            {
                AppendClass(ref cls, "flex items-center relative");
                if (!VerticalBarCollapsed)
                    AppendClass(ref cls, "w-full");
            }
        });

        if (Disabled == true)
            attributes["aria-disabled"] = "true";
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Disabled);
        hc.Add(Indentation);
        hc.Add(Expanded);
        hc.Add(Mode);
        hc.Add(VerticalBarCollapsed);
        hc.Add(ForceCollapseAll);
        if (ParentDropdown?.CollapseId is not null)
            hc.Add(ParentDropdown.CollapseId);
    }
}