@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements IStepPanel

<div @attributes="BuildAttributes()">
    @if (RenderMode == StepsRenderMode.Default || Active || (RenderMode == StepsRenderMode.LazyLoad && _lazyLoaded))
    {
        @ChildContent
    }
</div>

@code {
    private StepsState? _parentStepsState;
    private StepsContentState? _parentStepContentState;
    private bool _lazyLoaded;

    /// <summary>
    /// Gets or sets the name of the step panel.
    /// </summary>
    [Parameter]
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the aria-describedby attribute value.
    /// </summary>
    [Parameter]
    public string? AriaDescribedBy { get; set; }

    [CascadingParameter]
    public StepsState? ParentStepsState
    {
        get => _parentStepsState;
        set
        {
            if (_parentStepsState == value)
                return;

            _parentStepsState = value;
            // Nudge render key so this component re-renders when the selected step changes
            AriaDescribedBy = _parentStepsState?.SelectedStep;
            StateHasChanged();
        }
    }

    [CascadingParameter]
    public StepsContentState? ParentStepContentState
    {
        get => _parentStepContentState;
        set
        {
            if (_parentStepContentState == value)
                return;

            _parentStepContentState = value;
            // Nudge render key so this component re-renders when the selected panel changes
            AriaDescribedBy = _parentStepContentState?.SelectedPanel;
            StateHasChanged();
        }
    }

    [CascadingParameter]
    public Steps? ParentSteps { get; set; }

    [CascadingParameter]
    public StepsContent? ParentStepContent { get; set; }

    private bool Active => _parentStepsState?.SelectedStep == Name || _parentStepContentState?.SelectedPanel == Name;

    private StepsRenderMode RenderMode => _parentStepsState?.RenderMode ?? StepsRenderMode.Default;

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-step-panel");
            AppendClass(ref cls, "tab-pane");
            AppendClass(ref cls, "fade");
            
            if (Active)
            {
                AppendClass(ref cls, "show");
                AppendClass(ref cls, "active");
            }
        });
    }

    

    protected override void OnInitialized()
    {
        ParentSteps?.NotifyStepPanelInitialized(Name);
        ParentStepContent?.NotifyStepPanelInitialized(Name);
        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        if (Active)
            _lazyLoaded = RenderMode.Equals(StepsRenderMode.LazyLoad);

        base.OnParametersSet();
    }

    public override void Dispose()
    {
        ParentSteps?.NotifyStepPanelRemoved(Name);
        ParentStepContent?.NotifyStepPanelRemoved(Name);
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Name);
        hc.Add(AriaDescribedBy);
        hc.Add(Active);
        hc.Add(RenderMode);
        hc.Add(ParentStepsState?.SelectedStep);
        hc.Add(ParentStepContentState?.SelectedPanel);
    }
}