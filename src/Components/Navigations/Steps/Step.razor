@namespace Soenneker.Quark

@inherits Soenneker.Quark.Element
@implements IStep

<li @attributes="BuildAttributes()">
    <Anchor To="@GetHref()" OnClick="@(IsClickable ? HandleStepClick : null)" @attributes="BuildAnchorAttributes()">
        @ChildContent
    </Anchor>
</li>

@code {
    /// <summary>
    /// Gets or sets the name of the step.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    private StepsState? _parentStepsState;

    /// <summary>
    /// Gets or sets the index of the step.
    /// </summary>
    [Parameter]
    public int? Index { get; set; }

    /// <summary>
    /// Gets or sets whether the step is completed.
    /// </summary>
    [Parameter]
    public bool Completed { get; set; }

    /// <summary>
    /// Gets or sets whether the step is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets the aria-describedby attribute value.
    /// </summary>
    [Parameter]
    public string? AriaDescribedBy { get; set; }

    [CascadingParameter(Name = nameof(ParentStepsState))]
    public StepsState? ParentStepsState
    {
        get => _parentStepsState;
        set
        {
            if (_parentStepsState == value)
                return;

            _parentStepsState = value;
            AriaDescribedBy = _parentStepsState?.SelectedStep;
        }
    }

    [CascadingParameter(Name = nameof(ParentSteps))]
    public Steps? ParentSteps { get; set; }

    private bool Active 
    { 
        get 
        {
            var isActive = _parentStepsState?.SelectedStep == Name && !string.IsNullOrEmpty(Name);
            return isActive;
        }
    }

    private bool IsClickable => OnClick.HasDelegate;

    private int CalculatedIndex => Index ?? ParentSteps?.IndexOfStep(Name ?? string.Empty) ?? 1;

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-step");
            AppendClass(ref cls, "step-item");
        });
    }

    private Dictionary<string, object> BuildAnchorAttributes()
    {
        var attributes = new Dictionary<string, object>();
        
        BuildClassAttribute(attributes, (ref cls) =>
        {
            if (Active)
                AppendClass(ref cls, "active");
            if (Completed)
                AppendClass(ref cls, "text-success");
            if (Disabled)
                AppendClass(ref cls, "disabled");
            if (!IsClickable)
                AppendClass(ref cls, "non-clickable");
        });

        attributes["role"] = "tab";
        attributes["aria-selected"] = Active ? "true" : "false";
        attributes["aria-current"] = Active ? "step" : null;
        
        return attributes;
    }

    private string? GetHref()
    {
        return Name.HasContent() ? $"#{Name}" : null;
    }

    private async Task HandleStepClick(MouseEventArgs args)
    {
        await OnClick.InvokeAsync(args);

        if (ParentSteps != null && Name.HasContent())
        {
            await ParentSteps.SelectStep(Name);
        }
    }

    protected override void OnInitialized()
    {
        ParentSteps?.NotifyStepInitialized(Name ?? string.Empty);
        base.OnInitialized();
    }

    public override void Dispose()
    {
        ParentSteps?.NotifyStepRemoved(Name ?? string.Empty);
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Name);
        hc.Add(Completed);
        hc.Add(Disabled);
        hc.Add(OnClick.HasDelegate);
        hc.Add(_parentStepsState?.SelectedStep);
    }
}