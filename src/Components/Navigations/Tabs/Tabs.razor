@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements ITabs

<CascadingValue Name="ParentTabs" Value="this">
    @if (Vertical)
    {
        @* Vertical tabs layout *@
        <div class="row">
            <div class="col-3">
                <div @attributes="BuildAttributes()" >
                    @ChildContent
                </div>
            </div>
            <div class="col-9">
                <div class="tab-content">
                    @foreach (Tab tab in _tabs)
                    {
                        if (tab.Name == SelectedTab && !string.IsNullOrEmpty(tab.Title))
                        {
                            <div class="tab-pane active" role="tabpanel">
                                @tab.ChildContent
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        @* Horizontal tabs layout *@
        <div @attributes="BuildAttributes()" >
            @ChildContent
        </div>
        
        <div class="tab-content">
            @foreach (Tab tab in _tabs)
            {
                if (tab.Name == SelectedTab && !string.IsNullOrEmpty(tab.Title))
                {
                    <div class="tab-pane active" role="tabpanel">
                        @tab.ChildContent
                    </div>
                }
            }
        </div>
    }
</CascadingValue>

@code {
    /// <summary>
    /// Gets or sets whether the tabs should be displayed as pills.
    /// </summary>
    [Parameter]
    public bool Pills { get; set; }

    /// <summary>
    /// Gets or sets whether the tabs should be displayed vertically.
    /// </summary>
    [Parameter]
    public bool Vertical { get; set; }

    /// <summary>
    /// Gets or sets whether the tabs should be justified.
    /// </summary>
    [Parameter]
    public bool Justified { get; set; }

    /// <summary>
    /// Gets or sets the currently selected tab.
    /// </summary>
    [Parameter]
    public string? SelectedTab { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the selected tab changes.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnSelectedTabChanged { get; set; }

    private readonly List<Tab> _tabs = [];

    /// <summary>
    /// Registers a tab with the tabs component.
    /// </summary>
    /// <param name="tab">The tab to register.</param>
    public void RegisterTab(Tab tab)
    {
        if (!_tabs.Contains(tab))
        {
            _tabs.Add(tab);
            _ = RefreshOffThread();
        }
    }

    /// <summary>
    /// Unregisters a tab from the tabs component.
    /// </summary>
    /// <param name="tab">The tab to unregister.</param>
    public void UnregisterTab(Tab tab)
    {
        _tabs.Remove(tab);
        _ = RefreshOffThread();
    }

    /// <summary>
    /// Selects the specified tab.
    /// </summary>
    /// <param name="tabName">The name of the tab to select.</param>
    /// <returns>A task that represents the asynchronous operation.</returns>
    public async Task SelectTab(string tabName)
    {
        if (SelectedTab != tabName)
        {
            SelectedTab = tabName;

            if (OnSelectedTabChanged.HasDelegate)
            {
                await OnSelectedTabChanged.InvokeAsync(tabName);
            }

            InvalidateRender();
            Refresh();
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // If no selected tab is specified, select the first tab
        if (string.IsNullOrEmpty(SelectedTab) && _tabs.Count > 0)
        {
            Tab? firstTab = _tabs.FirstOrDefault(t => !t.Disabled);
            if (firstTab != null)
            {
                SelectedTab = firstTab.Name;
            }
        }
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        
        // Trigger a re-render when SelectedTab parameter changes
        // The Tab components will determine their active state based on the cascaded SelectedTab
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-tabs");
            AppendClass(ref cls, "inline-flex items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground");
            if (!Pills)
                AppendClass(ref cls, "flex flex-wrap gap-1");
            if (Vertical)
                AppendClass(ref cls, "flex-col");
            if (Justified)
                AppendClass(ref cls, "w-full [&>.q-tab]:flex-1");
        });
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Pills);
        hc.Add(Vertical);
        hc.Add(Justified);
        if (SelectedTab is not null)
            hc.Add(SelectedTab);
    }
}