@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements ITabs

<CascadingValue Name="ParentTabs" Value="this">
    <div @attributes="BuildAttributes()">
        @if (Vertical)
        {
            @* Vertical: TabsList left, content right - using grid for layout *@
            <div class="grid grid-cols-[auto_1fr] gap-4">
                <div role="tablist" class="group/tabs-list shrink-0" @attributes="BuildTabsListAttributes()">
                    @ChildContent
                </div>
                <div class="min-w-0 flex-1 outline-none" role="tabpanel" data-slot="tabs-content">
                    @foreach (Tab tab in _tabs)
                    {
                        @if (tab.Name == SelectedTab)
                        {
                            @tab.ChildContent
                            break;
                        }
                    }
                </div>
            </div>
        }
        else
        {
            @* Horizontal: TabsList top, content below - shadcn structure *@
            <div role="tablist" class="group/tabs-list w-fit" @attributes="BuildTabsListAttributes()">
                @ChildContent
            </div>
            <div class="flex-1 outline-none mt-2" role="tabpanel" data-slot="tabs-content">
                @foreach (Tab tab in _tabs)
                {
                    @if (tab.Name == SelectedTab)
                    {
                        @tab.ChildContent
                        break;
                    }
                }
            </div>
        }
    </div>
</CascadingValue>

@code {
    /// <summary>
    /// Gets or sets whether the tabs should be displayed as pills.
    /// </summary>
    [Parameter]
    public bool Pills { get; set; }

    /// <summary>
    /// Gets or sets whether the tabs should be displayed vertically.
    /// </summary>
    [Parameter]
    public bool Vertical { get; set; }

    /// <summary>
    /// Gets or sets whether the tabs should be justified.
    /// </summary>
    [Parameter]
    public bool Justified { get; set; }

    /// <summary>
    /// Gets or sets the currently selected tab.
    /// </summary>
    [Parameter]
    public string? SelectedTab { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the selected tab changes.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnSelectedTabChanged { get; set; }

    private readonly List<Tab> _tabs = [];

    /// <summary>
    /// Registers a tab with the tabs component.
    /// </summary>
    /// <param name="tab">The tab to register.</param>
    public void RegisterTab(Tab tab)
    {
        if (!_tabs.Contains(tab))
        {
            _tabs.Add(tab);
            _ = RefreshOffThread();
        }
    }

    /// <summary>
    /// Unregisters a tab from the tabs component.
    /// </summary>
    /// <param name="tab">The tab to unregister.</param>
    public void UnregisterTab(Tab tab)
    {
        _tabs.Remove(tab);
        _ = RefreshOffThread();
    }

    /// <summary>
    /// Selects the specified tab.
    /// </summary>
    /// <param name="tabName">The name of the tab to select.</param>
    /// <returns>A task that represents the asynchronous operation.</returns>
    public async Task SelectTab(string tabName)
    {
        if (SelectedTab != tabName)
        {
            SelectedTab = tabName;

            if (OnSelectedTabChanged.HasDelegate)
            {
                await OnSelectedTabChanged.InvokeAsync(tabName);
            }

            InvalidateRender();
            Refresh();
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // If no selected tab is specified, select the first tab
        if (string.IsNullOrEmpty(SelectedTab) && _tabs.Count > 0)
        {
            Tab? firstTab = _tabs.FirstOrDefault(t => !t.Disabled);
            if (firstTab != null)
            {
                SelectedTab = firstTab.Name;
            }
        }
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        
        // Trigger a re-render when SelectedTab parameter changes
        // The Tab components will determine their active state based on the cascaded SelectedTab
    }

    /// <summary>shadcn TabsList variant: default (bg-muted) or line (underline).</summary>
    [Parameter]
    public TabsListVariant TabsListVariant { get; set; } = TabsListVariant.Default;

    private Dictionary<string, object> BuildTabsListAttributes()
    {
        var attrs = new Dictionary<string, object>();
        attrs["data-slot"] = "tabs-list";
        attrs["data-variant"] = TabsListVariant.ToString().ToLowerInvariant();
        BuildClassAttribute(attrs, (ref cls) =>
        {
            AppendClass(ref cls, "q-tabs-list rounded-lg p-[3px] text-muted-foreground inline-flex items-center justify-center");
            AppendClass(ref cls, Vertical ? "h-fit flex-col" : "h-9");
            if (TabsListVariant == TabsListVariant.Default)
                AppendClass(ref cls, "bg-muted");
            else
                AppendClass(ref cls, "gap-1 bg-transparent rounded-none");
            if (Justified)
                AppendClass(ref cls, "w-full [&>.q-tab]:flex-1");
        });
        return attrs;
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);
        attributes["data-slot"] = "tabs";
        attributes["data-orientation"] = Vertical ? "vertical" : "horizontal";
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-tabs group/tabs flex gap-2");
            AppendClass(ref cls, Vertical ? "flex-col" : "flex-col");
        });
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Pills);
        hc.Add(Vertical);
        hc.Add(Justified);
        hc.Add(TabsListVariant);
        if (SelectedTab is not null)
            hc.Add(SelectedTab);
    }
}