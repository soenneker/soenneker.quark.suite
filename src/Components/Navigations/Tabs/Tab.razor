@namespace Soenneker.Quark

@inherits Soenneker.Quark.Element
@implements ITab

<li @attributes="BuildAttributes()">
    <button type="button" @onclick="HandleClick" @attributes="BuildButtonAttributes()">
        @if (IconName.HasContent())
        {
            <Icon Name="@IconName" />
        }
        @if (Title.HasContent())
        {
            @Title
        }
        else
        {
            @ChildContent
        }
    </button>
</li>

@code {

    /// <summary>
    /// Gets or sets the name of the tab.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// Gets or sets the name of the icon to display.
    /// </summary>
    [Parameter]
    public string? IconName { get; set; }

    /// <summary>
    /// Gets or sets the target element ID for the tab content.
    /// </summary>
    [Parameter]
    public string? Target { get; set; }

    /// <summary>
    /// Gets or sets whether the tab is active.
    /// </summary>
    [Parameter]
    public bool Active { get; set; }

    /// <summary>
    /// Gets or sets whether the tab is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    [CascadingParameter(Name = nameof(ParentTabs))]
    public Tabs? ParentTabs { get; set; }

    private bool IsActive => ParentTabs?.SelectedTab == Name;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Target is set only for static tabs that need external JS; dynamic tabs use custom logic
        if (string.IsNullOrEmpty(Target) && !string.IsNullOrEmpty(Name))
        {
            // For now, we'll handle all tabs through our custom logic
            // Target will remain null for dynamic tabs
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        
        if (firstRender && ParentTabs != null)
        {
            ParentTabs.RegisterTab(this);
        }
    }

    public override void Dispose()
    {
        if (ParentTabs != null)
        {
            ParentTabs.UnregisterTab(this);
        }
        base.Dispose();
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);
        attributes["role"] = "presentation";

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-tab");
            AppendClass(ref cls, "list-none");
            if (Disabled)
                AppendClass(ref cls, "opacity-50 pointer-events-none");
        });
    }

    // TabsTrigger: inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium + focus/disabled/active
    private const string _tabsTriggerBase =
        "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all " +
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 " +
        "disabled:pointer-events-none disabled:opacity-50 " +
        "data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm " +
        "[&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4";

    private IReadOnlyDictionary<string, object> BuildButtonAttributes()
    {
        var attributes = new Dictionary<string, object>();
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-tabs-trigger");
            AppendClass(ref cls, _tabsTriggerBase);
            AppendClass(ref cls, "group-data-[orientation=vertical]/tabs:w-full group-data-[orientation=vertical]/tabs:justify-start");
        });
        attributes["data-state"] = IsActive ? "active" : "inactive";
        attributes["role"] = "tab";
        if (Name.HasContent())
            attributes["id"] = $"tab-trigger-{Name}";
        attributes["aria-controls"] = Target ?? (Name.HasContent() ? $"tab-content-{Name}" : string.Empty);
        attributes["aria-selected"] = IsActive ? "true" : "false";
        attributes["tabindex"] = IsActive ? 0 : -1;
        if (Disabled)
            attributes["aria-disabled"] = "true";
        return attributes;
    }

    protected override async Task HandleClick(MouseEventArgs args)
    {
        if (!Disabled && ParentTabs != null && !string.IsNullOrEmpty(Name))
        {
            await ParentTabs.SelectTab(Name);
        }
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Name);
        hc.Add(IconName);
        hc.Add(Target);
        hc.Add(Disabled);
        if (ParentTabs?.SelectedTab is not null)
            hc.Add(ParentTabs.SelectedTab);
    }
}