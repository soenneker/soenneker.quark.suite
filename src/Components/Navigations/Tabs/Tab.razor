@namespace Soenneker.Quark

@inherits Soenneker.Quark.Element
@implements ITab

<li @attributes="BuildAttributes()">
    <button type="button" @onclick="HandleClick" @attributes="BuildButtonAttributes()">
        @if (IconName.HasContent())
        {
            <Icon Name="@IconName" />
        }
        @if (Title.HasContent())
        {
            @Title
        }
        else
        {
            @ChildContent
        }
    </button>
</li>

@code {

    /// <summary>
    /// Gets or sets the name of the tab.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// Gets or sets the name of the icon to display.
    /// </summary>
    [Parameter]
    public string? IconName { get; set; }

    /// <summary>
    /// Gets or sets the target element ID for the tab content.
    /// </summary>
    [Parameter]
    public string? Target { get; set; }

    /// <summary>
    /// Gets or sets whether the tab is active.
    /// </summary>
    [Parameter]
    public bool Active { get; set; }

    /// <summary>
    /// Gets or sets whether the tab is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    [CascadingParameter(Name = nameof(ParentTabs))]
    public Tabs? ParentTabs { get; set; }

    private bool IsActive => ParentTabs?.SelectedTab == Name;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Only set Target for static tabs that need Bootstrap's JavaScript
        // Dynamic tabs should not have Target set to avoid Bootstrap JS conflicts
        if (string.IsNullOrEmpty(Target) && !string.IsNullOrEmpty(Name))
        {
            // For now, we'll handle all tabs through our custom logic
            // Target will remain null for dynamic tabs
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        
        if (firstRender && ParentTabs != null)
        {
            ParentTabs.RegisterTab(this);
        }
    }

    public override void Dispose()
    {
        if (ParentTabs != null)
        {
            ParentTabs.UnregisterTab(this);
        }
        base.Dispose();
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        attributes["role"] = "presentation";

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-tab");
            AppendClass(ref cls, "list-none");
            if (Disabled)
                AppendClass(ref cls, "opacity-50 pointer-events-none");
        });
    }

    /// <summary>shadcn TabsTrigger classes from new-york-v4 ui/tabs.tsx</summary>
    private const string _tabsTriggerBase =
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring text-foreground/60 hover:text-foreground dark:text-muted-foreground dark:hover:text-foreground relative inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-all focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 " +
        "[&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 " +
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 data-[state=active]:text-foreground " +
        "group-data-[variant=default]/tabs-list:data-[state=active]:shadow-sm group-data-[variant=line]/tabs-list:data-[state=active]:shadow-none " +
        "group-data-[variant=line]/tabs-list:bg-transparent group-data-[variant=line]/tabs-list:data-[state=active]:bg-transparent " +
        "dark:group-data-[variant=line]/tabs-list:data-[state=active]:border-transparent dark:group-data-[variant=line]/tabs-list:data-[state=active]:bg-transparent " +
        "group-data-[orientation=horizontal]/tabs:after:inset-x-0 group-data-[orientation=horizontal]/tabs:after:bottom-[-5px] group-data-[orientation=horizontal]/tabs:after:h-0.5 " +
        "group-data-[orientation=vertical]/tabs:after:inset-y-0 group-data-[orientation=vertical]/tabs:after:-right-1 group-data-[orientation=vertical]/tabs:after:w-0.5 " +
        "after:bg-foreground after:absolute after:opacity-0 after:transition-opacity group-data-[variant=line]/tabs-list:data-[state=active]:after:opacity-100";

    private IReadOnlyDictionary<string, object> BuildButtonAttributes()
    {
        var attributes = new Dictionary<string, object>();
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-tabs-trigger");
            AppendClass(ref cls, _tabsTriggerBase);
            AppendClass(ref cls, "group-data-[orientation=vertical]/tabs:w-full group-data-[orientation=vertical]/tabs:justify-start");
        });
        attributes["data-slot"] = "tabs-trigger";
        attributes["data-state"] = IsActive ? "active" : "inactive";
        attributes["role"] = "tab";
        attributes["aria-controls"] = Target ?? string.Empty;
        attributes["aria-selected"] = IsActive ? "true" : "false";
        if (Disabled)
        {
            attributes["aria-disabled"] = "true";
            attributes["tabindex"] = -1;
        }
        return attributes;
    }

    protected override async Task HandleClick(MouseEventArgs args)
    {
        if (!Disabled && ParentTabs != null && !string.IsNullOrEmpty(Name))
        {
            await ParentTabs.SelectTab(Name);
        }
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Name);
        hc.Add(IconName);
        hc.Add(Target);
        hc.Add(Disabled);
        if (ParentTabs?.SelectedTab is not null)
            hc.Add(ParentTabs.SelectedTab);
    }
}