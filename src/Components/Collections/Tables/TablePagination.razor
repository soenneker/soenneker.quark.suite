@namespace Soenneker.Quark
@inherits Element

@if (ShowPagination)
{
	<div @attributes="BuildAttributes()">
		<div @attributes="BuildControlsAttributes()" >
			<Button Class="@PaginationButtonClass" OnClick="HandleFirstPage" disabled="@(ComputedCurrentPage == 1)" title="First" >«</Button>
			<Button Class="@PaginationButtonClass" OnClick="HandlePreviousPage" disabled="@(ComputedCurrentPage == 1)" title="Previous" >‹</Button>

			@if (ComputedTotalPages <= 1)
			{
				<Button Class="@ActivePaginationButtonClass" >
					1
				</Button>
			}
			else
			{
				@for (var p = StartPage; p <= EndPage; p++)
				{
					var pageNumber = p;
					<Button Class="@(pageNumber == ComputedCurrentPage ? ActivePaginationButtonClass : PaginationButtonClass)"
					        OnClick="@(() => HandleGoToPage(pageNumber))" >
						@pageNumber
					</Button>
				}
			}

			<Button Class="@PaginationButtonClass" OnClick="HandleNextPage" disabled="@(ComputedCurrentPage == ComputedTotalPages)" title="Next" >›</Button>
			<Button Class="@PaginationButtonClass" OnClick="HandleLastPage" disabled="@(ComputedCurrentPage == ComputedTotalPages)" title="Last" >»</Button>
		</div>
	</div>
}

@code {
	[CascadingParameter(Name = nameof(Table))]
	private ITable? Table { get; set; }

	[Parameter]
	public bool ShowPagination { get; set; } = true;

	[Parameter]
	public int CurrentPage { get; set; } = 1;

	[Parameter]
	public int TotalPages { get; set; } = 1;

	[Parameter]
	public int TotalRecords { get; set; }

	[Parameter]
	public int PageSize { get; set; } = 10;

	[Parameter]
	public int MaxPageButtons { get; set; } = 5;

	[Parameter]
	public EventCallback<int> OnGoToPage { get; set; }

	[Parameter]
	public EventCallback OnFirstPage { get; set; }

	[Parameter]
	public EventCallback OnPreviousPage { get; set; }

	[Parameter]
	public EventCallback OnNextPage { get; set; }

	[Parameter]
	public EventCallback OnLastPage { get; set; }

	// Computed properties that use Table values When available
	private int ComputedCurrentPage => Table?.CurrentPage ?? CurrentPage;
	private int ComputedTotalPages => Table?.TotalPages ?? TotalPages;
	private int ComputedTotalRecords => Table?.TotalRecordsCount ?? TotalRecords;
	private int ComputedPageSize => Table?.PageSize ?? PageSize;
	private int ComputedMaxPageButtons => MaxPageButtons;

	public int StartPage
	{
		get
		{
			if (ComputedTotalPages <= 0) return 1;
			if (ComputedCurrentPage <= 0) return 1;

			var halfButtons = ComputedMaxPageButtons / 2;
			var start = ComputedCurrentPage - halfButtons;
			start = Math.Max(1, start);

			if (start + ComputedMaxPageButtons - 1 > ComputedTotalPages)
			{
				start = Math.Max(1, ComputedTotalPages - ComputedMaxPageButtons + 1);
			}

			if (start > ComputedTotalPages) start = ComputedTotalPages;

			return start;
		}
	}

	public int EndPage => Math.Min(ComputedTotalPages, StartPage + ComputedMaxPageButtons - 1);

	private async Task HandleFirstPage()
	{
		if (Table != null)
		{
			await Table.HandleGoToPage(1);
		}
		else if (OnFirstPage.HasDelegate)
		{
			await OnFirstPage.InvokeAsync();
		}
		else if (OnGoToPage.HasDelegate)
		{
			await OnGoToPage.InvokeAsync(1);
		}
	}

	private async Task HandlePreviousPage()
	{
		if (Table != null && ComputedCurrentPage > 1)
		{
			await Table.HandleGoToPage(ComputedCurrentPage - 1);
		}
		else if (OnPreviousPage.HasDelegate)
		{
			await OnPreviousPage.InvokeAsync();
		}
		else if (OnGoToPage.HasDelegate && ComputedCurrentPage > 1)
		{
			await OnGoToPage.InvokeAsync(ComputedCurrentPage - 1);
		}
	}

	private async Task HandleNextPage()
	{
		if (Table != null && ComputedCurrentPage < ComputedTotalPages)
		{
			await Table.HandleGoToPage(ComputedCurrentPage + 1);
		}
		else if (OnNextPage.HasDelegate)
		{
			await OnNextPage.InvokeAsync();
		}
		else if (OnGoToPage.HasDelegate && ComputedCurrentPage < ComputedTotalPages)
		{
			await OnGoToPage.InvokeAsync(ComputedCurrentPage + 1);
		}
	}

	private async Task HandleLastPage()
	{
		if (Table != null)
		{
			await Table.HandleGoToPage(ComputedTotalPages);
		}
		else if (OnLastPage.HasDelegate)
		{
			await OnLastPage.InvokeAsync();
		}
		else if (OnGoToPage.HasDelegate)
		{
			await OnGoToPage.InvokeAsync(ComputedTotalPages);
		}
	}

	private async Task HandleGoToPage(int page)
	{
		if (Table != null)
		{
			await Table.HandleGoToPage(page);
		}
		else if (OnGoToPage.HasDelegate)
		{
			await OnGoToPage.InvokeAsync(page);
		}
	}

	// shadcn Pagination - new-york-v4 ui/pagination.tsx
	private const string PaginationButtonClass = "q-table-pagination-btn h-9 min-w-9 rounded-md border border-input bg-background px-3 py-1 text-sm font-medium shadow-xs transition-colors hover:bg-accent hover:text-accent-foreground disabled:pointer-events-none disabled:opacity-50";
	private const string ActivePaginationButtonClass = "q-table-pagination-btn active h-9 min-w-9 rounded-md border border-input bg-muted px-3 py-1 text-sm font-medium shadow-xs";

	protected override void BuildAttributesCore(Dictionary<string, object> attributes)
	{
		BuildClassAttribute(attributes, (ref cls) =>
		{
			AppendClass(ref cls, "q-table-pagination");
			AppendClass(ref cls, "flex flex-wrap items-center justify-center");
		});
	}

	private Dictionary<string, object> BuildControlsAttributes()
	{
		var attributes = new Dictionary<string, object>();
		BuildClassAttribute(attributes, (ref cls) => AppendClass(ref cls, "q-table-pagination-controls flex flex-wrap items-center justify-center gap-2"));
		return attributes;
	}

	protected override void ComputeRenderKeyCore(ref HashCode hc)
	{
		hc.Add(ShowPagination);
		hc.Add(CurrentPage);
		hc.Add(TotalPages);
		hc.Add(TotalRecords);
		hc.Add(PageSize);
		hc.Add(MaxPageButtons);
		hc.Add(ComputedCurrentPage);
		hc.Add(ComputedTotalPages);
		hc.Add(ComputedTotalRecords);
		hc.Add(ComputedPageSize);
	}
}