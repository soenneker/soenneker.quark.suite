@namespace Soenneker.Quark
@inherits Element

<th @onclick="HandleClick" @attributes="BuildAttributes()">
	@ChildContent @(Sortable ? GetSortIndicator() : string.Empty)
</th>

@code {
	[CascadingParameter(Name = nameof(Table))]
	private ITable? Table { get; set; }

	/// <summary>
	/// Gets or sets whether the column is sortable.
	/// </summary>
	[Parameter]
	public bool Sortable { get; set; } = true;

	/// <summary>
	/// Gets or sets whether the column is searchable.
	/// </summary>
	[Parameter]
	public bool Searchable { get; set; } = true;

	/// <summary>
	/// Gets or sets the text alignment for the column.
	/// </summary>
	[Parameter]
	public string Align { get; set; } = string.Empty;

	/// <summary>
	/// Gets or sets the data attribute value.
	/// </summary>
	[Parameter]
	public string? Data { get; set; }

	/// <summary>
	/// Gets or sets the name of the column.
	/// </summary>
	[Parameter]
	public string? Name { get; set; }

	private int _columnIndex = -1;

	protected override void OnInitialized()
	{
		// Register this column with the parent table to get its position
		if (Table != null)
		{
			_columnIndex = Table.RegisterColumn(this);
		}
	}

	protected override async Task HandleClick(MouseEventArgs e)
	{
		if (!Sortable || Table == null)
			return;

		await Table.HandleColumnSort(_columnIndex);
	}

	private string GetSortClass()
	{
		if (Table == null)
			return string.Empty;

		return Table.GetSortClassByIndex(_columnIndex);
	}

	private string GetSortIndicator()
	{
		if (Table == null)
			return " â†•";

		return Table.GetSortIndicatorByIndex(_columnIndex);
	}

	private string GetAlignStyle()
	{
		if (Align.IsNullOrWhiteSpace())
			return string.Empty;

		var align = Align.ToLowerInvariantFast();

		return align switch
		{
			"left" => "text-align: left;",
			"center" => "text-align: center;",
			"right" => "text-align: right;",
			_ => string.Empty
		};
	}

	protected override void BuildAttributesCore(Dictionary<string, object> attributes)
	{
		BuildClassAttribute(attributes, (ref cls) =>
		{
			AppendClass(ref cls, "q-table-th");
			
			if (Sortable)
			{
				var sortClass = GetSortClass();
				if (sortClass != null)
					AppendClass(ref cls, sortClass);
			}
		});

		var alignStyle = GetAlignStyle();
		if (Sortable || alignStyle.HasContent())
		{
			BuildStyleAttribute(attributes, (ref sty) =>
			{
				if (Sortable)
					AppendStyleDecl(ref sty, "cursor:pointer;");
				
				if (alignStyle.HasContent())
					AppendStyleDecl(ref sty, alignStyle);
			});
		}
	}

	protected override void ComputeRenderKeyCore(ref HashCode hc)
	{
		hc.Add(Sortable);
		hc.Add(Searchable);
		hc.Add(Align);
		hc.Add(Data);
		hc.Add(Name);
		hc.Add(_columnIndex);
	}
}