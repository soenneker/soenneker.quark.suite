@namespace Soenneker.Quark

@inherits Soenneker.Quark.Element
@using Soenneker.Blazor.Extensions.EventCallback
@implements IListGroup

<CascadingValue Name="ParentListGroup" Value="@this" IsFixed="true">
    <ul @attributes="BuildAttributes()">
        @ChildContent
    </ul>
</CascadingValue>

@code {
    /// <summary>
    /// Gets or sets whether the list group should be flush (no borders).
    /// </summary>
    [Parameter]
    public bool Flush { get; set; }

    /// <summary>
    /// Gets or sets whether the list group should be scrollable.
    /// </summary>
    [Parameter]
    public bool Scrollable { get; set; }

    /// <summary>
    /// Gets or sets the mode of the list group.
    /// </summary>
    [Parameter]
    public ListGroupMode Mode { get; set; } = ListGroupMode.Static;

    /// <summary>
    /// Gets or sets the selection mode of the list group.
    /// </summary>
    [Parameter]
    public ListGroupSelectionMode SelectionMode { get; set; } = ListGroupSelectionMode.Single;

    /// <summary>
    /// Gets or sets the selected item name (for single selection mode).
    /// </summary>
    [Parameter]
    public string? SelectedItem { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the selected item changes (for single selection mode).
    /// </summary>
    [Parameter]
    public EventCallback<string> SelectedItemChanged { get; set; }

    /// <summary>
    /// Gets or sets the list of selected item names (for multiple selection mode).
    /// </summary>
    [Parameter]
    public List<string>? SelectedItems { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the selected items change (for multiple selection mode).
    /// </summary>
    [Parameter]
    public EventCallback<List<string>> SelectedItemsChanged { get; set; }

    // shadcn-style list group - new-york-v4 (flex flex-col rounded-md border)
    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-list-group");
            AppendClass(ref cls, "flex flex-col rounded-md border border-border bg-card");
            if (Scrollable)
                AppendClass(ref cls, "overflow-auto");
        });
    }



    /// <summary>
    /// Selects or deselects the specified item.
    /// </summary>
    /// <param name="name">The name of the item to select or deselect.</param>
    /// <returns>A task that represents the asynchronous operation.</returns>
    public async Task SelectItem(string name)
    {
        if (string.IsNullOrEmpty(name))
            return;

        if (SelectionMode == ListGroupSelectionMode.Single)
        {
            // Optional: if already selected, no-op unless you support deselect
            if (!string.Equals(SelectedItem, name, StringComparison.Ordinal))
            {
                SelectedItem = name;
                await SelectedItemChanged.InvokeIfHasDelegate(name);
            }
        }
        else
        {
            List<string>? current = SelectedItems;

            // Copy (avoid mutating caller-owned list instance)
            List<string> next = current is null ? new List<string>(1) : [..current];

            int idx = next.IndexOf(name);
            if (idx >= 0)
                next.RemoveAt(idx);
            else
                next.Add(name);

            SelectedItems = next;

            await SelectedItemsChanged.InvokeIfHasDelegate(next);
        }

        await RefreshOffThread();
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Flush);
        hc.Add(Scrollable);
        hc.Add(Mode);
        hc.Add(SelectionMode);
        hc.Add(SelectedItem);
        if (SelectedItems is not null)
        {
            hc.Add(SelectedItems.Count);
            foreach (string item in SelectedItems)
            {
                hc.Add(item);
            }
        }
    }
}