@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements IAccordionHeader

<h2 @attributes="BuildAttributes()">
    <Button
        Type="@ButtonType.Button"
        Unstyled="true"
        OnClick="HandleClick"
        TabIndex="@(Disabled ? -1 : null)"
        @attributes="BuildButtonAttributes()">
        @if (IconName.HasContent())
        {
            <Icon Name="@IconName" />
        }
        @ChildContent
        <Icon Name="@(IsExpanded ? "chevron-up" : "chevron-down")" Class="accordion-icon q-accordion-icon" />
    </Button>
</h2>

@code {

    /// <summary>
    /// Gets or sets the name of the icon to display.
    /// </summary>
    [Parameter]
    public string? IconName { get; set; }

    /// <summary>
    /// Gets or sets whether the accordion header is expanded.
    /// </summary>
    [Parameter]
    public bool Expanded { get; set; }

    /// <summary>
    /// Gets or sets whether the accordion header is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether the header button should take full width.
    /// </summary>
    [Parameter]
    public bool FullWidth { get; set; } = true;

    [CascadingParameter(Name = nameof(ParentAccordionItem))]
    public AccordionItem? ParentAccordionItem { get; set; }

    private bool IsExpanded => ParentAccordionItem?.IsExpanded ?? Expanded;
    private bool IsDisabled => ParentAccordionItem?.Disabled ?? Disabled;

    private IReadOnlyDictionary<string, object> BuildButtonAttributes()
    {
        var attributes = new Dictionary<string, object>();
        
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-accordion-button");
            AppendClass(ref cls, "flex w-full items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180");
            if (!FullWidth)
                AppendClass(ref cls, "q-accordion-inline");
            if (!IsExpanded)
                AppendClass(ref cls, "data-[state=closed]:[&+div]:hidden");
            if (IsDisabled)
                AppendClass(ref cls, "opacity-50 pointer-events-none");
        });

        attributes["aria-expanded"] = IsExpanded ? "true" : "false";

        if (ParentAccordionItem?.Name.HasContent() == true)
            attributes["aria-controls"] = $"collapse-{ParentAccordionItem.Name}";

        if (IsDisabled)
        {
            attributes["aria-disabled"] = "true";
        }

        return attributes;
    }

    protected override async Task HandleClick(MouseEventArgs args)
    {
        if (!IsDisabled && ParentAccordionItem?.ParentAccordion != null && ParentAccordionItem.Name.HasContent())
        {
            await ParentAccordionItem.ParentAccordion.ToggleItem(ParentAccordionItem.Name);
        }
    }

    private bool _lastIsExpanded;
    private bool _expandedChanged;

    protected override void OnParametersSet()
    {
        bool current = IsExpanded;
        _expandedChanged |= current != _lastIsExpanded;
        _lastIsExpanded = current;
        base.OnParametersSet();
    }

    protected override bool ShouldRender()
    {
        return _expandedChanged || base.ShouldRender();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _expandedChanged = false;
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-accordion-header");
        });
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(IconName);
        hc.Add(Expanded);
        hc.Add(Disabled);
        hc.Add(FullWidth);
        hc.Add(IsExpanded);
        hc.Add(IsDisabled);
        if (ParentAccordionItem?.Name is not null)
            hc.Add(ParentAccordionItem.Name);
    }
}