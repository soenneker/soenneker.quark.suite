@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements IAccordionHeader

@* h3 + native button + inline SVG chevron with data-state for rotation *@
<h3 @attributes="BuildAttributes()">
    <button type="button"
            @onclick="HandleClick"
            @onkeydown="HandleKeyDown"
            @attributes="BuildButtonAttributes()">
        <div class="flex flex-1 items-center justify-between gap-4 py-4 font-medium transition-all hover:underline @(FullWidth ? "w-full" : "")">
            @if (IconName.HasContent())
            {
                <Icon Name="@IconName" />
            }
            @ChildContent
            <svg class="h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200 data-[state=open]:rotate-180"
                 data-state="@(IsExpanded ? "open" : "closed")"
                 xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </div>
    </button>
</h3>

@code {

    /// <summary>
    /// Gets or sets the name of the icon to display.
    /// </summary>
    [Parameter]
    public string? IconName { get; set; }

    /// <summary>
    /// Gets or sets whether the accordion header is expanded.
    /// </summary>
    [Parameter]
    public bool Expanded { get; set; }

    /// <summary>
    /// Gets or sets whether the accordion header is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Gets or sets whether the header button should take full width.
    /// </summary>
    [Parameter]
    public bool FullWidth { get; set; } = true;

    [CascadingParameter(Name = nameof(ParentAccordionItem))]
    public AccordionItem? ParentAccordionItem { get; set; }

    private bool IsExpanded => ParentAccordionItem?.IsExpanded ?? Expanded;
    private bool IsDisabled => ParentAccordionItem?.Disabled ?? Disabled;

    private IReadOnlyDictionary<string, object> BuildButtonAttributes()
    {
        var attributes = new Dictionary<string, object>();

        // trigger: flex w-full, focus ring, disabled (same semantics as shadcn)
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "flex w-full items-center justify-between text-left text-sm font-medium transition-all outline-none rounded-md focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50");
            if (!FullWidth)
                AppendClass(ref cls, "q-accordion-inline");
        });

        if (ParentAccordionItem?.TriggerId.HasContent() == true)
            attributes["id"] = ParentAccordionItem.TriggerId;
        attributes["aria-expanded"] = IsExpanded ? "true" : "false";
        if (ParentAccordionItem?.ContentId.HasContent() == true)
            attributes["aria-controls"] = ParentAccordionItem.ContentId;
        attributes["data-state"] = IsExpanded ? "open" : "closed";
        if (IsDisabled)
        {
            attributes["aria-disabled"] = "true";
            attributes["disabled"] = true;
        }

        return attributes;
    }

    private void HandleClick()
    {
        if (!IsDisabled && ParentAccordionItem?.ParentAccordion != null && ParentAccordionItem.Name.HasContent())
            _ = ParentAccordionItem.ParentAccordion.ToggleItem(ParentAccordionItem.Name);
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (IsDisabled) return;
        if (e.Key == " " || e.Key == "Enter")
        {
            if (ParentAccordionItem?.ParentAccordion != null && ParentAccordionItem.Name.HasContent())
                _ = ParentAccordionItem.ParentAccordion.ToggleItem(ParentAccordionItem.Name);
        }
    }

    private bool _lastIsExpanded;
    private bool _expandedChanged;

    protected override void OnParametersSet()
    {
        bool current = IsExpanded;
        _expandedChanged |= current != _lastIsExpanded;
        _lastIsExpanded = current;
        base.OnParametersSet();
    }

    protected override bool ShouldRender()
    {
        return _expandedChanged || base.ShouldRender();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _expandedChanged = false;
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        // header wrapper flex only
        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "flex");
        });
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(IconName);
        hc.Add(Expanded);
        hc.Add(Disabled);
        hc.Add(FullWidth);
        hc.Add(IsExpanded);
        hc.Add(IsDisabled);
        if (ParentAccordionItem?.Name is not null)
            hc.Add(ParentAccordionItem.Name);
    }
}