@using Soenneker.Blazor.Extensions.EventCallback

@namespace Soenneker.Quark
@inherits Overlay
@implements IModal

@if (Visible)
{
    <CascadingValue Name="ParentModal" Value="@this">
        <div @onkeydown="HandleKeyDown" @onclick="HandleBackdropClick" @attributes="BuildAttributes()">
            @if (ShowBackdrop)
            {
                <div class="fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0"></div>
            }
            <div @attributes="BuildDialogAttributes()" @onclick:stopPropagation="true">
                @ChildContent
            </div>
        </div>
    </CascadingValue>
}

@code {
    /// <summary>
    /// Gets or sets whether the modal should be centered vertically.
    /// </summary>
    [Parameter]
    public bool Centered { get; set; }

    /// <summary>
    /// Gets or sets whether the modal content should be scrollable.
    /// </summary>
    [Parameter]
    public bool Scrollable { get; set; }

    /// <summary>
    /// Gets or sets the size of the modal.
    /// </summary>
    [Parameter]
    public ModalSize? ModalSize { get; set; }

    /// <summary>
    /// Gets or sets whether the modal backdrop is static (doesn't close on click).
    /// </summary>
    [Parameter]
    public bool Static { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked When the backdrop is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnBackdropClick { get; set; }

    protected override void BuildAttributesCore(Dictionary<string, object> attributes)
    {
        base.BuildAttributesCore(attributes);

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-modal");
            AppendClass(ref cls, "fixed inset-0 z-50");
            if (!Visible)
                AppendClass(ref cls, "pointer-events-none invisible");
        });

        if (Visible)
            BuildStyleAttribute(attributes, (ref sty) => AppendStyleDecl(ref sty, "display: flex"));

        attributes["tabindex"] = -1;
        attributes["data-state"] = Visible ? "open" : "closed";

        if (Static)
            attributes["data-backdrop"] = "static";
    }

    // shadcn DialogContent - new-york-v4 ui/dialog.tsx
    private Dictionary<string, object> BuildDialogAttributes()
    {
        var attributes = new Dictionary<string, object>();

        BuildClassAttribute(attributes, (ref cls) =>
        {
            AppendClass(ref cls, "q-modal-dialog");
            AppendClass(ref cls, "fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border bg-background p-6 shadow-lg duration-200 outline-none sm:max-w-lg");
            AppendClass(ref cls, "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95");
            if (Scrollable)
                AppendClass(ref cls, "max-h-[90vh] overflow-y-auto");
            if (ModalSize != null && !string.IsNullOrEmpty(ModalSize.Value))
            {
                var size = ModalSize.Value.ToLowerInvariant();
                if (size == "sm") AppendClass(ref cls, "sm:max-w-sm");
                else if (size == "lg") AppendClass(ref cls, "sm:max-w-2xl");
                else if (size == "xl") AppendClass(ref cls, "sm:max-w-4xl");
            }
        });

        attributes["role"] = "dialog";
        attributes["aria-modal"] = "true";
        attributes["data-state"] = Visible ? "open" : "closed";

        return attributes;
    }

    protected virtual async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (!Static && e.Key == "Escape")
        {
            await Hide();
        }
    }

    private async Task HandleBackdropClick(MouseEventArgs args)
    {
        if (!Static)
        {
            await OnBackdropClick.InvokeIfHasDelegate();
            await Hide();
        }
    }

    /// <summary>
    /// Shows the modal.
    /// </summary>
    public async Task Show()
    {
        if (!Visible)
        {
            Visible = true;

            await VisibleChanged.InvokeAsync(Visible);
            await OnShow.InvokeIfHasDelegate();
            await RefreshOffThread();
        }
    }

    /// <summary>
    /// Hides the modal.
    /// </summary>
    public async Task Hide()
    {
        if (Visible)
        {
            Visible = false;

            await VisibleChanged.InvokeAsync(Visible);
            await OnHide.InvokeIfHasDelegate();
            await RefreshOffThread();
        }
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Centered);
        hc.Add(Scrollable);
        hc.Add(ModalSize);
        hc.Add(Static);
        hc.Add(Visible);
    }
}