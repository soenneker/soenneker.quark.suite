@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements ISnackbar

<CascadingValue Value="@this" IsFixed="true" >
    <div @attributes="BuildAttributes()" role="alert" aria-live="assertive" aria-atomic="true" >
        <div @attributes="GetContentAttributes()" >
            @ChildContent
        </div>
    </div>
</CascadingValue>

@code {

    /// <summary>
    /// Gets or sets the unique key for the snackbar.
    /// </summary>
    [Parameter]
    public string Key { get; set; } = "";

    /// <summary>
    /// Gets or sets whether the snackbar is visible.
    /// </summary>
    [Parameter]
    public bool Visible { get; set; } = true;

    /// <summary>
    /// Gets or sets the delay in milliseconds before the snackbar automatically hides.
    /// </summary>
    [Parameter]
    public int AutoHideDelay { get; set; } = 5000;

    /// <summary>
    /// Gets or sets the callback invoked when the snackbar is closed.
    /// </summary>
    [Parameter]
    public EventCallback<SnackbarClosedEventArgs> Closed { get; set; }

    [CascadingParameter(Name = nameof(ParentSnackbar))]
    protected SnackbarStack? ParentSnackbar { get; set; }

    protected override void BuildAttributesCore(Dictionary<string, object> attrs)
    {
        // base helpers from Component
        EnsureClassAttr(attrs, "q-snackbar");
        EnsureClassAttr(attrs, "snackbar-item");

        if (Visible)
            EnsureClassAttr(attrs, "snackbar-slide-in");
        else
            EnsureClassAttr(attrs, "d-none");

        // ARIA visibility
        SetOrRemove(attrs, "aria-hidden", !Visible, "true");

        // Stable key
        if (Key.HasContent())
            attrs["data-snackbar-key"] = Key!;
    }

    private static Dictionary<string, object> GetContentAttributes()
    {
        var inner = new Dictionary<string, object>(1);

        var cls = "snackbar-content rounded shadow p-3";
        inner["class"] = cls;

        return inner;
    }

    /// <summary>
    /// Shows the snackbar.
    /// </summary>
    /// <returns>A task that represents the asynchronous operation.</returns>
    public Task Show()
    {
        if (Visible) return Task.CompletedTask;
        Visible = true;
        return RefreshOffThread();
    }

    /// <summary>
    /// Hides the snackbar.
    /// </summary>
    /// <returns>A task that represents the asynchronous operation.</returns>
    public Task Hide() => Hide(SnackbarCloseReason.UserClosed);

    protected async Task Hide(SnackbarCloseReason reason)
    {
        if (!Visible) return;

        Visible = false;
        await RefreshOffThread();
        await Closed.InvokeAsync(new SnackbarClosedEventArgs(Key, reason));
    }

    protected override void ApplyBackgroundColor(ref PooledStringBuilder sty, ref PooledStringBuilder cls)
    {
        if (BackgroundColor is { IsEmpty: false })
        {
            bool isTheme = BackgroundColor.Value.TryGetBootstrapThemeToken(out string? token);

            if (isTheme && token is not null)
            {
                AppendClass(ref cls, $"bg-{token}");
            }
            else
            {
                var result = BackgroundColor.ToString();
                if (!result.HasContent()) return;

                if (BackgroundColor.Value.IsCssStyle)
                    AppendStyleDecl(ref sty, $"background-color: {result}");
                else
                    AppendClass(ref cls, $"bg-{result}");
            }
        }
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Key);
        hc.Add(Visible);
        hc.Add(AutoHideDelay);
    }
}