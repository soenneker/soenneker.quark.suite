@using Soenneker.Blazor.Extensions.EventCallback
@namespace Soenneker.Quark
@inherits Soenneker.Quark.Element
@implements ISnackbar

<CascadingValue Value="@this" IsFixed="true">
    <div @attributes="BuildAttributes()" role="alert" aria-live="assertive" aria-atomic="true">
        @if (ChildContent is not null)
        {
            @ChildContent
        }
        else
        {
            <div class="grid gap-1">
                @if (SnackbarTitle.HasContent())
                {
                    <div class="text-sm font-semibold">@SnackbarTitle</div>
                }
                @if (Message.HasContent())
                {
                    <div class="text-sm opacity-90">@Message</div>
                }
            </div>
        }

        @if (ShowAction && ActionText.HasContent())
        {
            <button type="button" class="@GetActionClass()" @onclick="HandleActionClick">
                @ActionText
            </button>
        }

        @if (ShowClose)
        {
            <button type="button" class="@GetCloseClass()" @onclick="HandleCloseClick" aria-label="Close">
                <span aria-hidden="true" class="size-4">X</span>
                <span class="sr-only">@GetCloseText()</span>
            </button>
        }
    </div>
</CascadingValue>

@code {

    /// <summary>
    /// Optional title text.
    /// </summary>
    [Parameter]
    public string? SnackbarTitle { get; set; }

    /// <summary>
    /// Optional message text When ChildContent is not provided.
    /// </summary>
    [Parameter]
    public string? Message { get; set; }

    /// <summary>
    /// Whether the close button is shown.
    /// </summary>
    [Parameter]
    public bool ShowClose { get; set; } = true;

    /// <summary>
    /// Label for close semantics.
    /// </summary>
    [Parameter]
    public string? CloseText { get; set; }

    /// <summary>
    /// Whether an action button is shown.
    /// </summary>
    [Parameter]
    public bool ShowAction { get; set; }

    /// <summary>
    /// Action button text.
    /// </summary>
    [Parameter]
    public string? ActionText { get; set; }

    /// <summary>
    /// Callback for the action button.
    /// </summary>
    [Parameter]
    public EventCallback ActionClicked { get; set; }

    /// <summary>
    /// Gets or sets the unique key for the snackbar.
    /// </summary>
    [Parameter]
    public string Key { get; set; } = "";

    /// <summary>
    /// Gets or sets whether the snackbar is visible.
    /// </summary>
    [Parameter]
    public bool Visible { get; set; } = true;

    /// <summary>
    /// Gets or sets the delay in milliseconds before the snackbar automatically hides.
    /// </summary>
    [Parameter]
    public int AutoHideDelay { get; set; } = 5000;

    /// <summary>
    /// Gets or sets the callback invoked When the snackbar is closed.
    /// </summary>
    [Parameter]
    public EventCallback<SnackbarClosedEventArgs> Closed { get; set; }

    [CascadingParameter(Name = nameof(ParentSnackbar))]
    protected SnackbarStack? ParentSnackbar { get; set; }

    protected override void BuildAttributesCore(Dictionary<string, object> attrs)
    {
        // shadcn toast item classes
        EnsureClassAttr(attrs, "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all");
        EnsureClassAttr(attrs, "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full");
        EnsureClassAttr(attrs, "q-snackbar");

        attrs["data-state"] = Visible ? "open" : "closed";
        SetOrRemove(attrs, "aria-hidden", !Visible, "true");

        if (Key.HasContent())
            attrs["data-snackbar-key"] = Key!;
    }

    private string GetActionClass() =>
        "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50";

    private string GetCloseClass() =>
        "absolute top-2 right-2 rounded-md p-1 opacity-0 transition-opacity text-foreground/50 hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring group-hover:opacity-100";

    private string GetCloseText() => CloseText.HasContent() ? CloseText! : "Close";

    /// <summary>
    /// Shows the snackbar.
    /// </summary>
    /// <returns>A task that represents the asynchronous operation.</returns>
    public Task Show()
    {
        if (Visible) return Task.CompletedTask;
        Visible = true;
        return RefreshOffThread();
    }

    /// <summary>
    /// Hides the snackbar.
    /// </summary>
    /// <returns>A task that represents the asynchronous operation.</returns>
    public Task Hide() => Hide(SnackbarCloseReason.UserClosed);

    protected async Task Hide(SnackbarCloseReason reason)
    {
        if (!Visible) return;

        Visible = false;
        await RefreshOffThread();
        await Closed.InvokeAsync(new SnackbarClosedEventArgs(Key, reason));
    }

    private async Task HandleCloseClick(MouseEventArgs _)
    {
        await Hide(SnackbarCloseReason.UserClosed);
    }

    private async Task HandleActionClick(MouseEventArgs _)
    {
        await ActionClicked.InvokeIfHasDelegate();
        await Hide(SnackbarCloseReason.UserClosed);
    }

    protected override void ApplyBackgroundColor(ref PooledStringBuilder sty, ref PooledStringBuilder cls)
    {
        if (BackgroundColor is { IsEmpty: false })
        {
            bool isTheme = BackgroundColor.Value.TryGetThemeToken(out string? token);

            if (isTheme && token is not null)
            {
                AppendClass(ref cls, $"bg-{token}");
            }
            else
            {
                var result = BackgroundColor.ToString();
                if (!result.HasContent()) return;

                if (BackgroundColor.Value.IsCssStyle)
                    AppendStyleDecl(ref sty, $"background-color: {result}");
                else
                    AppendClass(ref cls, $"bg-{result}");
            }
        }
    }

    protected override void ComputeRenderKeyCore(ref HashCode hc)
    {
        hc.Add(Key);
        hc.Add(Visible);
        hc.Add(AutoHideDelay);
        hc.Add(SnackbarTitle);
        hc.Add(Message);
        hc.Add(ShowClose);
        hc.Add(CloseText);
        hc.Add(ShowAction);
        hc.Add(ActionText);
    }
}