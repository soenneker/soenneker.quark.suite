@page "/data/tables/topbar"
@using System.Threading
@using Soenneker.DataTables.Dtos.ServerSideRequest
@using Soenneker.Extensions.String
@using Soenneker.Quark.Suite.Demo.Services
@using Soenneker.Quark.Suite.Demo.Dtos

@inject EmployeeService EmployeeService

<PageTitle>TopBar Demo - Table</PageTitle>

<Div class="demo-hero">
    <Container>
        <Row>
            <Column ColumnSize="ColumnSize.Is12" Class="text-center">
                <Div class="hero-content">
                    <Div class="demo-icon">üéõÔ∏è</Div>
                    <H1 Class="demo-title">TopBar Table Demo</H1>
                    <Paragraph Class="demo-subtitle">Custom topbar with search and controls layout for enhanced user experience.</Paragraph>
                </Div>
            </Column>
        </Row>
    </Container>
</Div>

<Container>
    <Card Class="demo-card">
        <CardHeader>
            <Div class="card-header-content">
                <H3><Icon Name="sliders-h" Margin="Margin.Is2.FromEnd"/>Advanced Employee Directory</H3>
                <Paragraph TextColor="TextColor.Muted" Margin="Margin.Is0.FromBottom">Custom controls with department filtering and export functionality</Paragraph>
            </Div>
        </CardHeader>
        <CardBody>
            <Table @ref="_topbarTable"
                        OnInteraction="OnInteraction"
                        OnOrder="HandleOrder"
                        OnInitialize="HandleInitialize"
                        Options="_topbarTableOptions"
                        TotalRecords="@_totalRecords" >

                <TableTopBar>
                    <TableLeft>
                        <TableSearch Placeholder="Search employees..." />
                    </TableLeft>
                    <TableRight>
                        <select class="custom-select" @onchange="HandleDepartmentFilter" >
                            <option value="" >All Departments</option>
                            <option value="Engineering" >Engineering</option>
                            <option value="Marketing" >Marketing</option>
                            <option value="Sales" >Sales</option>
                            <option value="HR" >HR</option>
                        </select>
                        <Button Class="custom-btn export-btn" OnClick="HandleExport">
                            <Icon Name="download" Margin="Margin.Is1.FromEnd"/>Export CSV
                        </Button>
                        <Button Class="custom-btn refresh-btn" OnClick="HandleRefresh">
                            <Icon Name="sync-alt" Margin="Margin.Is1.FromEnd"/>Refresh
                        </Button>
                    </TableRight>
                </TableTopBar>

                <TableElement>
                    <Thead>
                        <Tr>
                            <Th Data="Name" Sortable="true" Searchable="true" >Name</Th>
                            <Th Data="test.dept" Sortable="true" Searchable="true" >Department</Th>
                            <Th Data="Email" Sortable="true" Searchable="true" >Email</Th>
                            <Th Data="Salary" Sortable="true" Searchable="true" >Salary</Th>
                            <Th Data="HireDate" Sortable="true" Searchable="true" >Hire Date</Th>
                        </Tr>
                    </Thead>

                    <Tbody>
                        @if (_employees != null)
                        {
                            @foreach (var employee in _employees)
                            {
                                <Tr>
                                    <Td>@employee.Name</Td>
                                    <Td>@employee.Department</Td>
                                    <Td>@employee.Email</Td>
                                    <Td>@employee.Salary.ToString("C")</Td>
                                    <Td>@employee.HireDate.ToString("MM/dd/yyyy")</Td>
                                </Tr>
                            }
                        }
                    </Tbody>
                </TableElement>
                <TableBottomBar LayoutClass="only-right">
                    <TableRight>
                        <TableInfo />
                        <TablePagination />
                    </TableRight>
                </TableBottomBar>

            </Table>
        </CardBody>
    </Card>

    <Card Margin="Margin.Is4.FromTop">
        <CardHeader>
            <H4>Code Example</H4>
        </CardHeader>
        <CardBody>
            <CodeEditor ReadOnly="true" 
                        Language="@("html")" 
                        AutoHeight="true" Text="@(@"<Table Options=""_tableOptions"" TotalRecords=""@_totalRecords"">
    <TableTopBar>
        <TableLeft>
            <TableSearch Placeholder=""Search..."" />
        </TableLeft>
        <TableRight>
            <select class=""custom-select"" @onchange=""HandleFilter"">
                <option value="""">All Items</option>
                <option value=""Option1"">Option 1</option>
            </select>
        </TableRight>
    </TableTopBar>
    <TableElement>
        <Thead>
            <Tr>
                <Th Data=""Name"">Name</Th>
            </Tr>
        </Thead>
        <Tbody>
            @foreach (var item in _items)
            {
                <Tr><Td>@item.Name</Td></Tr>
            }
        </Tbody>
    </TableElement>
    <TableBottomBar>
        <TableInfo />
        <TablePagination />
    </TableBottomBar>
</Table>")" />
        </CardBody>
    </Card>
</Container>

<style>
    .demo-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4rem 0;
        margin-bottom: 3rem;
        position: relative;
        overflow: hidden;
    }

    .demo-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .hero-content {
        position: relative;
        z-index: 1;
    }

    .demo-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        display: block;
    }

    .demo-title {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        background: linear-gradient(45deg, #fff, #f8f9fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .demo-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
    }

    .demo-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: none;
        margin-bottom: 3rem;
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
        padding: 2rem;
    }

    .card-header-content h3 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .card-body {
        padding: 2rem;
    }

    /* Custom controls styling */
    .custom-select {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        color: #495057;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }

    .custom-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
    }

    .custom-btn {
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .export-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .export-btn:hover {
        background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .refresh-btn {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
    }

    .refresh-btn:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    @@media (max-width: 768px) {
        .demo-title {
            font-size: 2rem;
        }
        
        .demo-subtitle {
            font-size: 1rem;
        }
        
        .card-header,
        .card-body {
            padding: 1.5rem;
        }
        
        .custom-select,
        .custom-btn {
            width: 100%;
            margin: 0.5rem 0;
        }
    }
</style>

@code {
    private Table _topbarTable = null!;
    private readonly TableOptions _topbarTableOptions = new();
    private List<Employee>? _employees;
    private int _totalRecords;
    private string _selectedDepartment = string.Empty;

    private async Task HandleInitialize()
    {
        await LoadEmployees();
    }

    private async Task OnInteraction()
    {
        await LoadEmployees();
    }

    private async Task HandleOrder()
    {
        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        var serverRequest = new DataTableServerSideRequest
        {
            Start = ((_topbarTable?.CurrentPage ?? 1) - 1) * (_topbarTable?.PageSize ?? 10),
            Length = _topbarTable?.PageSize ?? 10,
            Search = new DataTableSearchRequest {Value = _topbarTable?.SearchTerm ?? string.Empty},
            Order = []
        };

        // Add sorting if available
        if (_topbarTable?.SortBy.HasContent() == true)
        {
            var columnIndex = GetColumnIndex(_topbarTable.SortBy);
            if (columnIndex >= 0)
            {
                serverRequest.Order.Add(new DataTableOrderRequest
                {
                    Column = columnIndex,
                    Dir = _topbarTable?.SortDirection?.ToLower() == "desc" ? "desc" : "asc"
                });
            }
        }

        var pagedResult = await EmployeeService.GetEmployeesPaged(serverRequest, CancellationToken.None);

        // Apply department filter if selected
        _employees = pagedResult.Items;
        if (_selectedDepartment.HasContent())
        {
            _employees = _employees.Where(e => e.Department == _selectedDepartment).ToList();
        }

        _totalRecords = pagedResult.TotalCount ?? 0;

        await InvokeAsync(StateHasChanged);
    }

    private static int GetColumnIndex(string sortBy)
    {
        return sortBy.ToLower() switch
        {
            "name" => 0,
            "test.dept" => 1,
            "email" => 2,
            "salary" => 3,
            "hiredate" => 4,
            _ => 0
        };
    }

    private async Task HandleDepartmentFilter(ChangeEventArgs e)
    {
        _selectedDepartment = e.Value?.ToString() ?? string.Empty;

        if (_topbarTable != null)
        {
            await _topbarTable.GoToPage(1); // Reset to first page when filtering
        }

        await LoadEmployees();
    }

    private async Task HandleExport()
    {

        // Here you would implement your CSV export logic
        await Task.Delay(500); // Simulate export delay
        // For demo purposes, just log the action
    }

    private async Task HandleRefresh()
    {
        await LoadEmployees();
    }

}
