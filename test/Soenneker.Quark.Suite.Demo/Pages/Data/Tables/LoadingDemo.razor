@page "/data/tables/loading-demo"
@using Microsoft.Extensions.Logging
@using Soenneker.DataTables.Dtos.ServerSideRequest
@using Soenneker.Quark.Suite.Demo.Services
@using Soenneker.Quark.Suite.Demo.Dtos
@using Soenneker.Utils.Delay

@inject ILogger<LoadingDemo> Logger
@inject EmployeeService EmployeeService

<PageTitle>Loading Demo - Table</PageTitle>

<Div class="demo-hero">
    <Container>
        <Row>
            <Column ColumnSize="ColumnSize.Is12" Class="text-center">
                <Div class="hero-content">
                    <Div class="demo-icon">⚡</Div>
                    <H1 Class="demo-title">Loading Behavior Demo</H1>
                    <Paragraph Class="demo-subtitle">Smooth loading behavior with overlay that prevents jarring flickering effects.</Paragraph>
                </Div>
            </Column>
        </Row>
    </Container>
</Div>

<Container>
    <Card Class="demo-card">
        <CardHeader>
            <Div class="card-header-content">
                <H3><Icon Name="spinner" Margin="Margin.Is2.FromEnd"/>Employee Directory</H3>
                <Paragraph TextColor="TextColor.Muted" Margin="Margin.Is0.FromBottom">Try searching, sorting, or changing pages to see the smooth loading overlay</Paragraph>
            </Div>
        </CardHeader>
        <CardBody>
            <Table @ref="_tableRef"
                        TotalRecords="@_totalRecords"
                        OnInteraction="HandleServerSideRequest" >

                <TableSearch Placeholder="Search employees..." />

                <TableLoader />

                <TableElement>
                    <Thead>
                        <Tr>
                            <Th Sortable="true" Searchable="true" >Name</Th>
                            <Th Sortable="true" Searchable="true" >Department</Th>
                            <Th Sortable="true" Searchable="true" >Email</Th>
                            <Th Sortable="true" Searchable="true" >Salary</Th>
                            <Th Sortable="true" Searchable="true" >Hire Date</Th>
                            <Th Sortable="true" Searchable="true" >Status</Th>
                        </Tr>
                    </Thead>

                    <Tbody>
                        @if (_currentEmployees is {Count: > 0})
                        {
                            @foreach (Employee employee in _currentEmployees)
                            {
                                <Tr Key="@employee.Id" >
                                    <Td>@employee.Name</Td>
                                    <Td>@employee.Department</Td>
                                    <Td>@employee.Email</Td>
                                    <Td>@employee.Salary.ToString("C")</Td>
                                    <Td>@employee.HireDate.ToString("MMM dd, yyyy")</Td>
                                    <Td>@employee.Status</Td>
                                </Tr>
                            }
                        }
                        else if (_tableRef.HasLoadedOnce)
                        {
                            <TableNoData>
                                <Div class="no-data-content">
                                    <Div class="no-data-icon">⚡</Div>
                                    <h4>No employees found</h4>
                                    <Paragraph>Try adjusting your search criteria or filters.</Paragraph>
                                </Div>
                            </TableNoData>
                        }
                    </Tbody>
                </TableElement>

                <TableBottomBar>
                    <TableInfo />
                    <TablePagination />
                </TableBottomBar>
            </Table>
        </CardBody>
    </Card>

    <Card Margin="Margin.Is4.FromTop">
        <CardHeader>
            <H4>Code Example</H4>
        </CardHeader>
        <CardBody>
            <CodeEditor ReadOnly="true" 
                        Language="@("html")" 
                        AutoHeight="true" Text="@(@"<Table Options=""_tableOptions"" TotalRecords=""@_totalRecords"">
    <TableSearch />
    <TableElement>
        <Thead>
            <Tr>
                <Th Data=""Name"" Sortable=""true"">Name</Th>
                <Th Data=""Email"" Sortable=""true"">Email</Th>
            </Tr>
        </Thead>
        <Tbody>
            @if (_items == null)
            {
                <TableLoadingRow ColumnCount=""2""/>
            }
            else
            {
                @foreach (var item in _items)
                {
                    <Tr>
                        <Td>@item.Name</Td>
                        <Td>@item.Email</Td>
                    </Tr>
                }
            }
        </Tbody>
    </TableElement>
    <TableBottomBar>
        <TableInfo />
        <TablePagination />
    </TableBottomBar>
</Table>")" />
        </CardBody>
    </Card>
</Container>

@code {
    private Table? _tableRef;
    private List<Employee> _currentEmployees = [];
    private int _totalRecords;

    protected override void OnInitialized()
    {
        _totalRecords = EmployeeService.GetTotalCount();
    }

    private async Task HandleServerSideRequest(DataTableServerSideRequest request)
    {
        Logger.LogInformation("LoadingDemo: HandleServerSideRequest called: Start={Start}, Length={Length}", request.Start, request.Length);

        try
        {
            // Simulate loading delay BEFORE fetching data
            await DelayUtil.Delay(3000, Logger);

            // Get filtered employees using the service
            List<Employee> employees = await EmployeeService.GetFilteredEmployees(request);

            Logger.LogInformation("LoadingDemo: EmployeeService returned {Count} employees", employees.Count);

            // Update the current employees list
            _currentEmployees = employees;

            // Update table paging state (optional for demo; keeps pages/counts coherent)
            if (_tableRef is not null)
                _tableRef.UpdateContinuationTokenPaging(employees.Count, null);

            Logger.LogInformation("LoadingDemo: Updated currentEmployees with {Count} records, totalRecords={TotalRecords}", _currentEmployees.Count, _totalRecords);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "LoadingDemo: Error handling server-side request: {Message}", ex.Message);
        }
    }

}
