@page "/forms/textedits"
@using Microsoft.Extensions.Logging
@using Soenneker.Extensions.String

@inject ILogger<Index> Logger

<PageTitle>TextEdits - Quark Suite</PageTitle>

<Div Class="space-y-8 max-w-4xl">
    <Div Class="space-y-6">
        <section class="space-y-4">
            <DemoSection Title="Binding test" Description="Type in the fields below or click 'Load Test Data' to verify binding works." Code="@(@"<TextEdit Id=""testInput1"" Placeholder=""Type something..."" @bind-Text=""_testField1""/>
<TextEdit Id=""testInput2"" @bind-Text=""_testField2""/>
<TextEdit Id=""testInput3"" @bind-Text=""_testField3""/>")">
                <Div Class="p-4 rounded-lg border border-border bg-muted/30 space-y-4">
                    <H3 Class="text-lg font-semibold" Margin="Margin.Is0.FromBottom">Two-Way Binding</H3>

                    <Field>
                        <FieldLabel For="testInput1">Test Field 1:</FieldLabel>
                        <FieldBody>
                            <TextEdit Id="testInput1"
                                      Placeholder="Type something here..."
                                      @bind-Text="_testField1"/>
                            <Div Margin="Margin.Is2.FromTop" Padding="Padding.Is2" Class="rounded border border-border bg-background">
                                <Strong>Bound Value:</Strong> <Code>@(_testField1 ?? "(empty)")</Code>
                            </Div>
                        </FieldBody>
                    </Field>

                    <Field>
                        <FieldLabel For="testInput2">Test Field 2:</FieldLabel>
                        <FieldBody>
                            <TextEdit Id="testInput2"
                                      Placeholder="Type something here..."
                                      @bind-Text="_testField2"/>
                            <Div Margin="Margin.Is2.FromTop" Padding="Padding.Is2" Class="rounded border border-border bg-background">
                                <Strong>Bound Value:</Strong> <Code>@(_testField2 ?? "(empty)")</Code>
                            </Div>
                        </FieldBody>
                    </Field>

                    <Field>
                        <FieldLabel For="testInput3">Test Field 3 (Pre-populated):</FieldLabel>
                        <FieldBody>
                            <TextEdit Id="testInput3"
                                      Placeholder="This should show pre-populated value..."
                                      @bind-Text="_testField3"/>
                            <Div Margin="Margin.Is2.FromTop" Padding="Padding.Is2" Class="rounded border border-border bg-background">
                                <Strong>Bound Value:</Strong> <Code>@(_testField3 ?? "(empty)")</Code>
                            </Div>
                        </FieldBody>
                    </Field>

                    <Div Class="flex flex-wrap gap-2 mt-4">
                        <Button Class="bg-primary text-primary-foreground" OnClick="LoadTestData">Load Test Data</Button>
                        <Button Class="bg-secondary text-secondary-foreground" OnClick="ClearTestData">Clear Test Data</Button>
                        <Button Class="bg-muted text-muted-foreground" OnClick="UpdateTestData">Update to Random Values</Button>
                    </Div>

                    <Div Class="mt-4 p-3 rounded-lg border border-border bg-muted/30">
                        <H4 Class="text-sm font-semibold">Test Results:</H4>
                        <UnorderedList Margin="Margin.Is0.FromBottom">
                            <UnorderedListItem>
                                <Strong>Field 1:</Strong> @(_testField1 ?? "(not set)")
                            </UnorderedListItem>
                            <UnorderedListItem>
                                <Strong>Field 2:</Strong> @(_testField2 ?? "(not set)")
                            </UnorderedListItem>
                            <UnorderedListItem>
                                <Strong>Field 3:</Strong> @(_testField3 ?? "(not set)")
                            </UnorderedListItem>
                        </UnorderedList>
                    </Div>
                </Div>
            </DemoSection>
        </section>

        <DemoSection Title="Basic TextEdit" Description="Standard binding and expression tree binding." Code="@(@"<Field>
    <FieldLabel For=""basicInput"">Basic Input</FieldLabel>
    <FieldBody>
        <TextEdit Id=""basicInput"" Placeholder=""Enter some text..."" @bind-Text=""_basicValue""/>
    </FieldBody>
</Field>
<TextEdit Id=""expressionInput"" Placeholder=""Uses expression tree..."" @bind-Text=""_expressionValue""/>")">
                <Field>
                    <FieldLabel For="basicInput">Basic Input (Standard binding)</FieldLabel>
                    <FieldBody>
                        <TextEdit Id="basicInput" Placeholder="Enter some text..." @bind-Text="_basicValue"/>
                        <Small Class="form-text" TextColor="TextColor.Muted">Current value: @_basicValue</Small>
                    </FieldBody>
                </Field>
                <Field>
                    <FieldLabel For="expressionInput">Expression Tree Binding</FieldLabel>
                    <FieldBody>
                        <TextEdit Id="expressionInput" Placeholder="Uses expression tree..." @bind-Text="_expressionValue"/>
                        <Small Class="form-text" TextColor="TextColor.Muted">Current value: @_expressionValue</Small>
                    </FieldBody>
                </Field>
        </DemoSection>

                <DemoSection Title="TextEdit with Validation" Description="Validations, Validation, ValidationError with TextEdit." Code="@(@"<Validations Model=""_validationModel"">
    <Validation Action=""@ValidateRequired"">
        <TextEdit Id=""validatedInput"" Placeholder=""Required..."" @bind-Text=""_validationModel.RequiredField""/>
        <ValidationError/>
    </Validation>
</Validations>")">
                <Validations Model="_validationModel">
                    <Div Class="space-y-4">
                        <Field>
                            <FieldLabel For="validatedInput" RequiredIndicator="true">Required Field</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateRequired">
                                    <TextEdit Id="validatedInput"
                                              Placeholder="This field is required..."
                                              @bind-Text="_validationModel.RequiredField"/>
                                    <ValidationError/>
                                </Validation>
                            </FieldBody>
                        </Field>

                        <Field>
                            <FieldLabel For="emailInput">Email Field</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateEmail">
                                    <TextEdit Id="emailInput"
                                              Placeholder="Enter a valid email..."
                                              @bind-Text="_validationModel.EmailField"/>
                                    <ValidationError/>
                                </Validation>
                            </FieldBody>
                        </Field>

                        <Field>
                            <FieldLabel For="patternInput">Phone Number (Pattern Validation)</FieldLabel>
                            <FieldBody>
                                <Validation UsePattern="true" PatternString="^[\d\s\-\(\)\+]+$">
                                    <TextEdit Id="patternInput"
                                              Placeholder="Enter phone number..."
                                              @bind-Text="_validationModel.PhoneField"/>
                                    <ValidationError/>
                                </Validation>
                            </FieldBody>
                        </Field>
                    </Div>
                </Validations>
                </DemoSection>

                <DemoSection Title="Form with Multiple Validations" Description="Validations with Row/Column layout and Validate All." Code="@(@"<Validations @ref=""_validationsRef"" Model=""_formModel"">
    <Field>
        <FieldLabel For=""firstName"" RequiredIndicator=""true"">First Name</FieldLabel>
        <FieldBody>
            <Validation Action=""@ValidateRequired"">
                <TextEdit Id=""firstName"" @bind-Text=""_formModel.FirstName""/>
                <ValidationError/>
            </Validation>
        </FieldBody>
    </Field>
    <Button OnClick=""ValidateAll"">Validate All Fields</Button>
</Validations>")">
                <Validations @ref="_validationsRef" Model="_formModel">
                    <Row>
                        <Column ColumnSize="ColumnSize.Is6.OnXl">
                            <Field>
                                <FieldLabel For="firstName" RequiredIndicator="true">First Name</FieldLabel>
                                <FieldBody>
                                    <Validation Action="@ValidateRequired">
                                        <TextEdit Id="firstName"
                                                  Placeholder="First name..."
                                                  @bind-Text="_formModel.FirstName"/>
                                        <ValidationError/>
                                    </Validation>
                                </FieldBody>
                            </Field>
                        </Column>
                        <Column ColumnSize="ColumnSize.Is6.OnXl">
                            <Field>
                                <FieldLabel For="lastName" RequiredIndicator="true">Last Name</FieldLabel>
                                <FieldBody>
                                    <Validation Action="@ValidateRequired">
                                        <TextEdit Id="lastName"
                                                  Placeholder="Last name..."
                                                  @bind-Text="_formModel.LastName"/>
                                        <ValidationError/>
                                    </Validation>
                                </FieldBody>
                            </Field>
                        </Column>
                    </Row>

                    <Field>
                        <FieldLabel For="company">Company</FieldLabel>
                        <FieldBody>
                            <Validation Action="@ValidateCompany">
                                <TextEdit Id="company"
                                          Placeholder="Company name..."
                                          @bind-Text="_formModel.Company"/>
                                <ValidationError/>
                            </Validation>
                        </FieldBody>
                    </Field>

                    <Button BackgroundColor="BackgroundColor.Primary" OnClick="ValidateAll">Validate All Fields</Button>
                    <Button BackgroundColor="BackgroundColor.Secondary" OnClick="ClearAll" Margin="Margin.Is2.FromStart">Clear All</Button>
                </Validations>
                </DemoSection>
    </Div>
</Div>

@code{

    // Binding Test Fields
    private string? _testField1;
    private string? _testField2;
    private string? _testField3 = "Initial Value for Field 3";

    private string _basicValue = string.Empty;
    private string _expressionValue = string.Empty;

    private ValidationModel _validationModel = new();
    private FormModel _formModel = new();

    private Validations? _validationsRef;

    protected override void OnInitialized()
    {
    }

    private void LoadTestData()
    {
        _testField1 = "Test Data 1 - Loaded";
        _testField2 = "Test Data 2 - Loaded";
        _testField3 = "Test Data 3 - Loaded";
        Logger.LogInformation("Test data loaded: Field1={Field1}, Field2={Field2}, Field3={Field3}", _testField1, _testField2, _testField3);
    }

    private void ClearTestData()
    {
        _testField1 = null;
        _testField2 = null;
        _testField3 = null;
        Logger.LogInformation("Test data cleared");
    }

    private void UpdateTestData()
    {
        _testField1 = $"Random-{Guid.NewGuid().ToString()[..8]}";
        _testField2 = $"Random-{Guid.NewGuid().ToString()[..8]}";
        _testField3 = $"Random-{Guid.NewGuid().ToString()[..8]}";
        Logger.LogInformation("Test data updated with random values");
    }

    private void ValidateRequired(ValidatorEventArgs e)
    {
        if (e.Value.ToString().IsNullOrWhiteSpace() == true)
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "This field is required.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidateEmail(ValidatorEventArgs e)
    {
        var email = e.Value.ToString();

        if (email.IsNullOrWhiteSpace())
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Email is required.";
        }
        else if (!email.Contains("@") || !email.Contains("."))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Please enter a valid email address.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidateCompany(ValidatorEventArgs e)
    {
        var company = e.Value?.ToString();
        if (company.IsNullOrWhiteSpace())
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Company name is required.";
        }
        else if (company.Length < 2)
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Company name must be at least 2 characters.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private async Task ValidateAll()
    {
        if (_validationsRef is not null)
        {
            await _validationsRef.Validate();
        }
    }

    private async Task ClearAll()
    {
        if (_validationsRef is not null)
        {
            await _validationsRef.ClearAll();
        }

        _formModel = new FormModel();
        await InvokeAsync(StateHasChanged);
    }

    public class ValidationModel
    {
        public string RequiredField { get; set; } = string.Empty;
        public string EmailField { get; set; } = string.Empty;
        public string PhoneField { get; set; } = string.Empty;
    }

    public class FormModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Company { get; set; } = string.Empty;
    }

}
