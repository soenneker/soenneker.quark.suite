@page "/forms/validation-demo"

<PageTitle>Validation - Quark Suite</PageTitle>

<Div Class="space-y-8 max-w-4xl">
    <Div Class="space-y-6">
            <DemoSection Title="Basic Validation" Description="Required field and email validation with Validations, Validation, ValidationError." Code="@(@"<Validations @ref=""_validationsRef"" Model=""_model"">
    <Field>
        <FieldLabel For=""requiredField"" RequiredIndicator=""true"">Required Field</FieldLabel>
        <FieldBody>
            <Validation Action=""@ValidateRequired"">
                <TextEdit Id=""requiredField"" @bind-Value=""_model.RequiredField"" />
                <ValidationError />
            </Validation>
        </FieldBody>
    </Field>
    <Field>
        <FieldLabel For=""emailField"">Email Address</FieldLabel>
        <FieldBody>
            <Validation Action=""@ValidateEmail"">
                <TextEdit Id=""emailField"" Type=""email"" @bind-Value=""_model.EmailField"" />
                <ValidationError />
            </Validation>
        </FieldBody>
    </Field>
    <Button BackgroundColor=""@BackgroundColor.Primary"" @onclick=""ValidateForm"">Validate Form</Button>
</Validations>")">
                <Div Margin="Margin.Is3.FromEnd" Class="space-y-4">
                    <Validations @ref="_basicValidationsRef" Model="_basicModel">
                        <Field>
                            <FieldLabel For="requiredField" RequiredIndicator="true">Required Field</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateRequired">
                                    <TextEdit Id="requiredField" Placeholder="This field is required" @bind-Value="_basicModel.RequiredField" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>
                        <Field>
                            <FieldLabel For="emailField">Email Address</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateEmail">
                                    <TextEdit Id="emailField" Type="email" Placeholder="Enter email address" @bind-Value="_basicModel.EmailField" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>
                        <Button BackgroundColor="@BackgroundColor.Primary" @onclick="ValidateBasicForm">Validate Form</Button>
                    </Validations>
                </Div>
                <Paragraph TextColor="TextColor.Muted" Margin="Margin.Is0">Basic validation with required field and email validation.</Paragraph>
            </DemoSection>

            <Hr/>

            <DemoSection Title="Complex Form Validation" Description="Multi-field form with Field, FieldLabel, FieldBody, Validation, and custom validators." Code="@(@"<Validations @ref=""_validationsRef"" Model=""_model"">
    <Field>
        <FieldLabel For=""firstName"" RequiredIndicator=""true"">First Name</FieldLabel>
        <FieldBody>
            <Validation Action=""@ValidateRequired"">
                <TextEdit Id=""firstName"" @bind-Value=""_model.FirstName"" />
                <ValidationError />
            </Validation>
        </FieldBody>
    </Field>
    <Field>
        <FieldLabel For=""email"" RequiredIndicator=""true"">Email</FieldLabel>
        <FieldBody>
            <Validation Action=""@ValidateEmail"">
                <TextEdit Id=""email"" Type=""email"" @bind-Value=""_model.Email"" />
                <ValidationError />
            </Validation>
        </FieldBody>
    </Field>
    <Button BackgroundColor=""@BackgroundColor.Success"" @onclick=""ValidateForm"">Validate All</Button>
</Validations>")">
                <Div Margin="Margin.Is3.FromEnd" Class="space-y-4">
                    <Validations @ref="_complexValidationsRef" Model="_complexModel">
                        <Row>
                            <Column Size="ColumnSize.Is6">
                                <Field>
                                    <FieldLabel For="firstName" RequiredIndicator="true">First Name</FieldLabel>
                                    <FieldBody>
                                        <Validation Action="@ValidateRequired">
                                            <TextEdit Id="firstName" Placeholder="Enter first name" @bind-Value="_complexModel.FirstName" />
                                            <ValidationError />
                                        </Validation>
                                    </FieldBody>
                                </Field>
                            </Column>
                            <Column Size="ColumnSize.Is6">
                                <Field>
                                    <FieldLabel For="lastName" RequiredIndicator="true">Last Name</FieldLabel>
                                    <FieldBody>
                                        <Validation Action="@ValidateRequired">
                                            <TextEdit Id="lastName" Placeholder="Enter last name" @bind-Value="_complexModel.LastName" />
                                            <ValidationError />
                                        </Validation>
                                    </FieldBody>
                                </Field>
                            </Column>
                        </Row>

                        <Field>
                            <FieldLabel For="email" RequiredIndicator="true">Email Address</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateEmail">
                                    <TextEdit Id="email" Type="email" Placeholder="Enter email address" @bind-Value="_complexModel.Email" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>

                        <Field>
                            <FieldLabel For="phone">Phone Number</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidatePhone">
                                    <TextEdit Id="phone" Type="tel" Placeholder="Enter phone number" @bind-Value="_complexModel.Phone" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>

                        <Field>
                            <FieldLabel For="age">Age</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateAge">
                                    <NumericEdit Id="age" Placeholder="Enter age" @bind-Value="_complexModel.Age" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>

                        <Field>
                            <FieldLabel For="password" RequiredIndicator="true">Password</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidatePassword">
                                    <TextEdit Id="password" Type="password" Placeholder="Enter password" @bind-Value="_complexModel.Password" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>

                        <Field>
                            <FieldLabel For="confirmPassword" RequiredIndicator="true">Confirm Password</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateConfirmPassword">
                                    <TextEdit Id="confirmPassword" Type="password" Placeholder="Confirm password" @bind-Value="_complexModel.ConfirmPassword" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>

                        <Field>
                            <FieldLabel For="acceptTerms" RequiredIndicator="true">Terms and conditions</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateTerms">
                                    <Check Id="acceptTerms" @bind-Checked="_complexModel.AcceptTerms" /> I accept the terms and conditions
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>
                        
                        <Div>
                            <Button BackgroundColor="@BackgroundColor.Success" @onclick="ValidateComplexForm" Margin="Margin.Is2.FromEnd">Validate All</Button>
                            <Button BackgroundColor="@BackgroundColor.Secondary" @onclick="ClearComplexForm">Clear Form</Button>
                        </Div>
                    </Validations>
                </Div>
            </DemoSection>

            <Hr/>

            <DemoSection Title="Pattern Validation" Description="UsePattern, PatternString, PatternMessage for regex validation." Code="@(@"<Validation UsePattern=""true"" PatternString=""^\d{5}(-\d{4})?$"" PatternMessage=""Please enter a valid US ZIP code"">
    <TextEdit Id=""zipCode"" @bind-Value=""_model.ZipCode"" />
    <ValidationError />
</Validation>")">
                <Div Margin="Margin.Is3.FromEnd" Class="space-y-4">
                    <Validations @ref="_patternValidationsRef" Model="_patternModel">
                        <Field>
                            <FieldLabel For="zipCode">ZIP Code (US Format)</FieldLabel>
                            <FieldBody>
                                <Validation UsePattern="true" PatternString="^\d{5}(-\d{4})?$" PatternMessage="Please enter a valid US ZIP code (12345 or 12345-6789)">
                                    <TextEdit Id="zipCode" Placeholder="12345 or 12345-6789" @bind-Value="_patternModel.ZipCode" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>
                        <Field>
                            <FieldLabel For="ssn">Social Security Number</FieldLabel>
                            <FieldBody>
                                <Validation UsePattern="true" PatternString="^\d{3}-\d{2}-\d{4}$" PatternMessage="Please enter SSN in format XXX-XX-XXXX">
                                    <TextEdit Id="ssn" Placeholder="XXX-XX-XXXX" @bind-Value="_patternModel.Ssn" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>
                        <Field>
                            <FieldLabel For="creditCard">Credit Card Number</FieldLabel>
                            <FieldBody>
                                <Validation UsePattern="true" PatternString="^\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}$" PatternMessage="Please enter a valid 16-digit credit card number">
                                    <TextEdit Id="creditCard" Placeholder="1234 5678 9012 3456" @bind-Value="_patternModel.CreditCard" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>
                        <Button BackgroundColor="@BackgroundColor.Primary" @onclick="ValidatePatternForm">Validate Patterns</Button>
                    </Validations>
                </Div>
            </DemoSection>

            <Hr/>

            <DemoSection Title="Custom Validation Messages" Description="Custom validators with Action and error messages." Code="@(@"<Validation Action=""@ValidateUsername"">
    <TextEdit Id=""username"" @bind-Value=""_model.Username"" />
    <ValidationError />
</Validation>")">
                <Div Margin="Margin.Is3.FromEnd" Class="space-y-4">
                    <Validations @ref="_customValidationsRef" Model="_customModel">
                        <Field>
                            <FieldLabel For="username">Username</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateUsername">
                                    <TextEdit Id="username" Placeholder="Enter username" @bind-Value="_customModel.Username" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>
                        <Field>
                            <FieldLabel For="website">Website URL</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateWebsite">
                                    <TextEdit Id="website" Type="url" Placeholder="https://example.com" @bind-Value="_customModel.Website" />
                                    <ValidationError />
                                </Validation>
                            </FieldBody>
                        </Field>
                        <Button BackgroundColor="@BackgroundColor.Primary" @onclick="ValidateCustomForm">Validate Custom</Button>
                    </Validations>
                </Div>
            </DemoSection>

            <Hr/>

            <DemoSection Title="Validation Success Messages" Description="ValidationSuccess component for success state." Code="@(@"<Validation Action=""@ValidateWithSuccess"">
    <TextEdit Id=""successField"" @bind-Value=""_model.SuccessField"" />
    <ValidationError />
    <ValidationSuccess />
</Validation>")">
                <Div Margin="Margin.Is3.FromEnd" Class="space-y-4">
                    <Validations @ref="_successValidationsRef" Model="_successModel">
                        <Field>
                            <FieldLabel For="successField">Field with Success Message</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateWithSuccess">
                                    <TextEdit Id="successField" Placeholder="Type 'success' for success message" @bind-Value="_successModel.SuccessField" />
                                    <ValidationError />
                                    <ValidationSuccess />
                                </Validation>
                            </FieldBody>
                        </Field>
                        <Button BackgroundColor="@BackgroundColor.Primary" @onclick="ValidateSuccessForm">Validate Success</Button>
                    </Validations>
                </Div>
            </DemoSection>

            <Hr/>

            <DemoSection Title="Validation Component Properties" Description="Validations, Validation, ValidationError, ValidationSuccess.">
                <Div BackgroundColor="BackgroundColor.Light" Padding="Padding.Is3" Margin="Margin.Is3.FromBottom">
                    <H3>Validation Features</H3>
                    <Paragraph>Validation components provide comprehensive form validation:</Paragraph>
                    <UnorderedList>
                        <UnorderedListItem><Strong>Validations:</Strong> Main validation container with model binding</UnorderedListItem>
                        <UnorderedListItem><Strong>Validation:</Strong> Individual field validation wrapper</UnorderedListItem>
                        <UnorderedListItem><Strong>ValidationError:</Strong> Displays validation error messages</UnorderedListItem>
                        <UnorderedListItem><Strong>ValidationSuccess:</Strong> Displays validation success messages</UnorderedListItem>
                        <UnorderedListItem><Strong>ValidationError:</Strong> Individual error message component</UnorderedListItem>
                        <UnorderedListItem><Strong>Pattern Validation:</Strong> Regex pattern validation support</UnorderedListItem>
                        <UnorderedListItem><Strong>Custom Validation:</Strong> Custom validation logic support</UnorderedListItem>
                        <UnorderedListItem><Strong>Model Binding:</Strong> Automatic model property validation</UnorderedListItem>
                    </UnorderedList>
                </Div>
            </DemoSection>

            <Hr/>

            <DemoSection Title="Real-time Validation" Description="Validates as you type.">
                <Div Margin="Margin.Is3.FromEnd" Class="space-y-4">
                    <Validations Model="_realtimeModel">
                        <Field>
                            <FieldLabel For="realtimeField">Real-time Validation</FieldLabel>
                            <FieldBody>
                                <Validation Action="@ValidateRealtime">
                                    <TextEdit Id="realtimeField" 
                                             Placeholder="Type to see real-time validation" 
                                             @bind-Value="_realtimeModel.RealtimeField"
                                             @oninput="HandleRealtimeInput" />
                                    <ValidationError />
                                    <ValidationSuccess />
                                </Validation>
                            </FieldBody>
                        </Field>
                    </Validations>
                </Div>
                <Paragraph TextColor="TextColor.Muted">This field validates in real-time as you type.</Paragraph>
            </DemoSection>
    </Div>
</Div>

@code {
    private Validations? _basicValidationsRef;
    private Validations? _complexValidationsRef;
    private Validations? _patternValidationsRef;
    private Validations? _customValidationsRef;
    private Validations? _successValidationsRef;

    private BasicModel _basicModel = new();
    private ComplexModel _complexModel = new();
    private PatternModel _patternModel = new();
    private CustomModel _customModel = new();
    private SuccessModel _successModel = new();
    private RealtimeModel _realtimeModel = new();

    // Basic Validation Methods
    private void ValidateRequired(ValidatorEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(e.Value?.ToString()))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "This field is required.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidateEmail(ValidatorEventArgs e)
    {
        var email = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(email))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Email address is required.";
        }
        else if (!email.Contains("@") || !email.Contains("."))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Please enter a valid email address.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidatePhone(ValidatorEventArgs e)
    {
        var phone = e.Value?.ToString();
        // Temporarily always show error for debugging
        e.Status = ValidationStatus.Error;
        e.ErrorText = "Please enter a valid phone number.";
        
        // Original logic (commented out for debugging)
        // if (!string.IsNullOrWhiteSpace(phone) && !System.Text.RegularExpressions.Regex.IsMatch(phone, @"^[\d\s\-\(\)\+]+$"))
        // {
        //     e.Status = ValidationStatus.Error;
        //     e.ErrorText = "Please enter a valid phone number.";
        // }
        // else
        // {
        //     e.Status = ValidationStatus.Success;
        // }
    }

    private void ValidateAge(ValidatorEventArgs e)
    {
        if (e.Value == null)
        {
            e.Status = ValidationStatus.Success;
            return;
        }

        if (decimal.TryParse(e.Value.ToString(), out decimal age))
        {
            if (age < 0 || age > 150)
            {
                e.Status = ValidationStatus.Error;
                e.ErrorText = "Please enter a valid age between 0 and 150.";
            }
            else
            {
                e.Status = ValidationStatus.Success;
            }
        }
        else
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Please enter a valid number.";
        }
    }

    private void ValidatePassword(ValidatorEventArgs e)
    {
        var password = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(password))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Password is required.";
        }
        else if (password.Length < 8)
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Password must be at least 8 characters long.";
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(password, @"^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)"))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Password must contain at least one lowercase letter, one uppercase letter, and one number.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidateConfirmPassword(ValidatorEventArgs e)
    {
        var confirmPassword = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(confirmPassword))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Please confirm your password.";
        }
        else if (confirmPassword != _complexModel.Password)
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Passwords do not match.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidateTerms(ValidatorEventArgs e)
    {
        if (!(bool)e.Value)
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "You must accept the terms and conditions.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidateUsername(ValidatorEventArgs e)
    {
        var username = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(username))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Username is required.";
        }
        else if (username.Length < 3)
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Username must be at least 3 characters long.";
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(username, @"^[a-zA-Z0-9_]+$"))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Username can only contain letters, numbers, and underscores.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidateWebsite(ValidatorEventArgs e)
    {
        var website = e.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(website))
        {
            if (!Uri.TryCreate(website, UriKind.Absolute, out Uri? uri) || (uri.Scheme != Uri.UriSchemeHttp && uri.Scheme != Uri.UriSchemeHttps))
            {
                e.Status = ValidationStatus.Error;
                e.ErrorText = "Please enter a valid website URL (including http:// or https://).";
            }
            else
            {
                e.Status = ValidationStatus.Success;
            }
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private void ValidateWithSuccess(ValidatorEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "This field is required.";
        }
        else if (value.ToLower() == "success")
        {
            e.Status = ValidationStatus.Success;
        }
        else
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Type 'success' to see the success message.";
        }
    }

    private void ValidateRealtime(ValidatorEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "This field cannot be empty.";
        }
        else if (value.Length < 5)
        {
            e.Status = ValidationStatus.Error;
            e.ErrorText = "Must be at least 5 characters.";
        }
        else
        {
            e.Status = ValidationStatus.Success;
        }
    }

    private async Task ValidateBasicForm()
    {
        if (_basicValidationsRef != null)
        {
            await _basicValidationsRef.Validate();
        }
    }

    private async Task ValidateComplexForm()
    {
        if (_complexValidationsRef != null)
        {
            await _complexValidationsRef.Validate();
        }
    }

    private async Task ClearComplexForm()
    {
        if (_complexValidationsRef != null)
        {
            await _complexValidationsRef.ClearAll();
        }
        _complexModel = new ComplexModel();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ValidatePatternForm()
    {
        if (_patternValidationsRef != null)
        {
            await _patternValidationsRef.Validate();
        }
    }

    private async Task ValidateCustomForm()
    {
        if (_customValidationsRef != null)
        {
            await _customValidationsRef.Validate();
        }
    }

    private async Task ValidateSuccessForm()
    {
        if (_successValidationsRef != null)
        {
            await _successValidationsRef.Validate();
        }
    }

    private void HandleRealtimeInput(ChangeEventArgs e)
    {
        // Real-time validation is handled automatically by the Validation component
        StateHasChanged();
    }

    // Model Classes
    public class BasicModel
    {
        public string RequiredField { get; set; } = string.Empty;
        public string EmailField { get; set; } = string.Empty;
    }

    public class ComplexModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public decimal? Age { get; set; } = null;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
        public bool AcceptTerms { get; set; } = false;
    }

    public class PatternModel
    {
        public string ZipCode { get; set; } = string.Empty;
        public string Ssn { get; set; } = string.Empty;
        public string CreditCard { get; set; } = string.Empty;
    }

    public class CustomModel
    {
        public string Username { get; set; } = string.Empty;
        public string Website { get; set; } = string.Empty;
    }

    public class SuccessModel
    {
        public string SuccessField { get; set; } = string.Empty;
    }

    public class RealtimeModel
    {
        public string RealtimeField { get; set; } = string.Empty;
    }

    protected override void OnInitialized()
    {
    }
}
